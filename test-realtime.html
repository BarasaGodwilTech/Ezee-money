<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-Time System Test - Ezee Money</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover {
            background: #0056b3;
        }
        .btn-success {
            background: #28a745;
        }
        .btn-success:hover {
            background: #1e7e34;
        }
        .btn-danger {
            background: #dc3545;
        }
        .btn-danger:hover {
            background: #c82333;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .log {
            background: #1e1e1e;
            color: #00ff00;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>üöÄ Ezee Money Real-Time System Test</h1>
    
    <div class="grid">
        <div class="card">
            <h2>üì± Field Agent Simulation</h2>
            <p>Simulate a field agent submitting data from their phone.</p>
            <button class="btn" onclick="simulateAgentSubmission()">1. Simulate Agent Submission</button>
            <button class="btn btn-success" onclick="openAgentPage()">2. Open Agent Page</button>
            <div id="agentStatus" class="status status-warning">Ready to test</div>
        </div>
        
        <div class="card">
            <h2>üñ•Ô∏è Admin Dashboard Simulation</h2>
            <p>Test real-time updates to admin dashboard.</p>
            <button class="btn" onclick="openAdminPage()">1. Open Admin Dashboard</button>
            <button class="btn btn-success" onclick="testRealTimeConnection()">2. Test Real-Time Connection</button>
            <div id="adminStatus" class="status status-warning">Ready to test</div>
        </div>
    </div>

    <div class="card">
        <h2>üìä Real-Time Test Results</h2>
        <div id="testResults"></div>
        <div class="log" id="testLog">Real-time test log will appear here...</div>
    </div>

    <div class="card">
        <h2>‚öôÔ∏è Configuration Check</h2>
        <button class="btn" onclick="checkConfiguration()">Check System Configuration</button>
        <pre id="configDisplay">Configuration will appear here...</pre>
    </div>

    <script src="js/real-time-service.js"></script>
    <script>
        let realTimeService;
        let testResults = [];

        function log(message, type = 'info') {
            const logElement = document.getElementById('testLog');
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? '‚ùå' : (type === 'success' ? '‚úÖ' : '‚ÑπÔ∏è');
            logElement.innerHTML += `[${timestamp}] ${prefix} ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
            
            // Also add to results
            addTestResult(message, type);
        }

        function addTestResult(message, type) {
            const resultsElement = document.getElementById('testResults');
            const className = type === 'error' ? 'status-error' : (type === 'success' ? 'status-success' : 'status-warning');
            resultsElement.innerHTML += `<div class="status ${className}">${message}</div>`;
        }

        function updateStatus(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.className = `status status-${type}`;
            element.textContent = message;
        }

        async function simulateAgentSubmission() {
            try {
                updateStatus('agentStatus', 'Simulating submission...', 'warning');
                
                // Create test submission
                const testSubmission = {
                    id: 'TEST-' + Date.now(),
                    fullName: 'Test Client',
                    personalNumber: 'TEST123456',
                    email: 'test@client.com',
                    nationalId: 'TESTID789',
                    dob: '1990-01-01',
                    gender: 'male',
                    businessAddress: 'Test Business Address',
                    residentialAddress: 'Test Residential Address',
                    nextOfKinName: 'Test Kin',
                    nextOfKinRelationship: 'spouse',
                    nextOfKinPhone: '+256700000000',
                    agentInfo: {
                        scCode: 'TEST001',
                        fullName: 'Test Agent'
                    },
                    images: {
                        idFront: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==',
                        idBack: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==',
                        agentPhoto: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg=='
                    },
                    submissionDate: new Date().toISOString(),
                    status: 'submitted'
                };

                // Initialize real-time service
                realTimeService = new RealTimeService();
                
                // Load admin config (agents use same token)
                const adminConfig = JSON.parse(localStorage.getItem('ezeeAdminConfig') || '{}');
                if (adminConfig.github?.token) {
                    const initialized = realTimeService.init(adminConfig.github);
                    if (initialized) {
                        log('Real-time service initialized', 'success');
                        
                        // Submit to GitHub
                        const result = await realTimeService.submitAgentData(testSubmission);
                        
                        if (result.success) {
                            log('Submission sent to GitHub successfully!', 'success');
                            updateStatus('agentStatus', 'Submission successful!', 'success');
                            log(`Submission ID: ${result.submissionId}`, 'success');
                        } else {
                            log('Failed to submit to GitHub', 'error');
                            updateStatus('agentStatus', 'Submission failed!', 'error');
                        }
                    } else {
                        log('Real-time service initialization failed', 'error');
                        updateStatus('agentStatus', 'Initialization failed!', 'error');
                    }
                } else {
                    log('No GitHub token found in admin config', 'error');
                    updateStatus('agentStatus', 'No GitHub token!', 'error');
                }
                
            } catch (error) {
                log('Error simulating submission: ' + error.message, 'error');
                updateStatus('agentStatus', 'Error occurred!', 'error');
            }
        }

        async function testRealTimeConnection() {
            try {
                updateStatus('adminStatus', 'Testing real-time connection...', 'warning');
                
                realTimeService = new RealTimeService();
                
                // Load admin config
                const adminConfig = JSON.parse(localStorage.getItem('ezeeAdminConfig') || '{}');
                if (adminConfig.github?.token) {
                    const initialized = realTimeService.init(adminConfig.github);
                    
                    if (initialized) {
                        log('Real-time service initialized', 'success');
                        
                        // Test repository access
                        const hasChanged = await realTimeService.hasRepositoryChanged();
                        log('Repository access test: ' + (hasChanged !== null ? 'Success' : 'Failed'), hasChanged !== null ? 'success' : 'error');
                        
                        // Test getting submissions
                        const submissions = await realTimeService.getSubmissions();
                        log(`Found ${submissions.length} submissions in repository`, 'success');
                        
                        // Start polling
                        realTimeService.startRealTimePolling();
                        log('Real-time polling started (5-second intervals)', 'success');
                        
                        updateStatus('adminStatus', 'Real-time connection active!', 'success');
                        
                        // Subscribe to updates
                        realTimeService.subscribe((data, type) => {
                            log(`Real-time update: ${type}`, 'success');
                            addTestResult(`Received real-time update: ${type}`, 'success');
                        });
                        
                    } else {
                        log('Failed to initialize real-time service', 'error');
                        updateStatus('adminStatus', 'Initialization failed!', 'error');
                    }
                } else {
                    log('No GitHub token found', 'error');
                    updateStatus('adminStatus', 'No GitHub token!', 'error');
                }
                
            } catch (error) {
                log('Error testing real-time connection: ' + error.message, 'error');
                updateStatus('adminStatus', 'Connection failed!', 'error');
            }
        }

        function checkConfiguration() {
            const adminConfig = JSON.parse(localStorage.getItem('ezeeAdminConfig') || '{}');
            const agentInfo = JSON.parse(localStorage.getItem('agentInfo') || '{}');
            
            const configDisplay = {
                adminConfig: adminConfig,
                agentInfo: agentInfo,
                githubToken: adminConfig.github?.token ? 'Present' : 'Missing',
                repository: adminConfig.github ? `${adminConfig.github.repoOwner}/${adminConfig.github.repoName}` : 'Not configured',
                branch: adminConfig.github?.branchName || 'Not configured'
            };
            
            document.getElementById('configDisplay').textContent = JSON.stringify(configDisplay, null, 2);
            
            if (adminConfig.github?.token) {
                log('GitHub configuration found', 'success');
                addTestResult('GitHub token is present', 'success');
            } else {
                log('GitHub configuration missing', 'error');
                addTestResult('GitHub token is missing - please configure in admin dashboard', 'error');
            }
        }

        function openAgentPage() {
            window.open('agent/submit.html', '_blank');
            log('Opened agent submission page in new tab', 'info');
        }

        function openAdminPage() {
            window.open('admin/dashboard.html', '_blank');
            log('Opened admin dashboard in new tab', 'info');
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            log('Real-time test page loaded', 'info');
            checkConfiguration();
        });
    </script>
</body>
</html>
