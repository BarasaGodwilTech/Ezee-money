<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Agent Management</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
        }
        
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            width: 250px;
            background-color: #1e3c72;
            color: white;
            padding: 20px 0;
            overflow-y: auto;
        }
        
        .logo {
            padding: 0 20px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 20px;
            text-align: center;
        }
        
        .logo h2 {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .nav-menu {
            list-style: none;
        }
        
        .nav-item {
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .nav-item:hover, .nav-item.active {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .nav-item i {
            width: 20px;
            text-align: center;
        }
        
        .config-panel {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin: 20px;
            display: none;
        }
        
        .config-panel h3 {
            color: #856404;
            margin-bottom: 10px;
        }
        
        .config-input {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        
        .config-input input {
            flex: 1;
            min-width: 200px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .config-btn {
            background-color: #856404;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .config-toggle {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #2a5298;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 100;
        }
        
        .main-content {
            margin-left: 250px;
            padding: 20px;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .header h1 {
            color: #1e3c72;
        }
        
        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .card {
            background-color: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        
        .stat-card {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        
        .stat-1 { background-color: #e3f2fd; color: #1565c0; }
        .stat-2 { background-color: #e8f5e9; color: #2e7d32; }
        .stat-3 { background-color: #fff3e0; color: #ef6c00; }
        .stat-4 { background-color: #fce4ec; color: #c2185b; }
        
        .stat-info h3 {
            font-size: 28px;
            margin-bottom: 5px;
        }
        
        .stat-info p {
            color: #666;
        }
        
        .agents-table-container {
            background-color: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            overflow-x: auto;
            margin-top: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            text-align: left;
            padding: 15px;
            border-bottom: 2px solid #eee;
            color: #1e3c72;
            font-weight: 600;
        }
        
        td {
            padding: 15px;
            border-bottom: 1px solid #eee;
        }
        
        tr:hover {
            background-color: #f9f9f9;
        }
        
        .status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }
        
        .status-pending {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .status-verified {
            background-color: #d4edda;
            color: #155724;
        }
        
        .status-complete {
            background-color: #d1ecf1;
            color: #0c5460;
        }
        
        .action-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .action-btn {
            padding: 8px 15px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .view-btn {
            background-color: #e3f2fd;
            color: #1565c0;
        }
        
        .view-btn:hover {
            background-color: #1565c0;
            color: white;
        }
        
        .verify-btn {
            background-color: #e8f5e9;
            color: #2e7d32;
        }
        
        .verify-btn:hover {
            background-color: #2e7d32;
            color: white;
        }
        
        .verify-btn:disabled {
            background-color: #ccc;
            color: #666;
            cursor: not-allowed;
        }
        
        .email-btn {
            background-color: #fff3e0;
            color: #ef6c00;
        }
        
        .email-btn:hover {
            background-color: #ef6c00;
            color: white;
        }
        
        .delete-btn {
            background-color: #ffebee;
            color: #d32f2f;
        }
        
        .delete-btn:hover {
            background-color: #d32f2f;
            color: white;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal-content {
            background-color: white;
            border-radius: 10px;
            width: 100%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background-color: white;
            z-index: 1;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }
        
        .agent-details {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .detail-group {
            margin-bottom: 20px;
        }
        
        .detail-label {
            font-weight: 600;
            color: #666;
            margin-bottom: 5px;
            font-size: 14px;
        }
        
        .detail-value {
            font-size: 16px;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 6px;
            min-height: 44px;
            display: flex;
            align-items: center;
        }
        
        .photo-section {
            margin-top: 30px;
        }
        
        .photos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }
        
        .photo-container {
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            background-color: #f5f5f5;
        }
        
        .photo-container img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            display: block;
        }
        
        .photo-label {
            padding: 10px;
            background-color: #f5f5f5;
            font-weight: 600;
            color: #333;
            text-align: center;
            border-top: 1px solid #eee;
        }
        
        .image-placeholder {
            width: 100%;
            height: 200px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: #e9ecef;
            color: #6c757d;
        }
        
        .verification-panel {
            background-color: #e8f5e9;
            border-radius: 10px;
            padding: 20px;
            margin-top: 30px;
            border: 1px solid #c8e6c9;
        }
        
        .verification-actions {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        @media (max-width: 992px) {
            .sidebar {
                width: 70px;
                padding: 20px 0;
            }
            
            .logo h2 span, .nav-item span {
                display: none;
            }
            
            .logo h2 {
                justify-content: center;
            }
            
            .nav-item {
                justify-content: center;
                padding: 15px 0;
            }
            
            .main-content {
                margin-left: 70px;
            }
        }
        
        @media (max-width: 768px) {
            .stats-cards {
                grid-template-columns: 1fr;
            }
            
            .main-content {
                padding: 15px;
            }
            
            .agent-details {
                grid-template-columns: 1fr;
            }
            
            .photos-grid {
                grid-template-columns: 1fr;
            }
            
            .header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .action-btn {
                width: 100%;
                justify-content: center;
            }
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .no-data {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .no-data i {
            font-size: 50px;
            margin-bottom: 20px;
            color: #ccc;
        }
        
        .refresh-btn {
            margin-left: 10px;
        }
        
        .home-link {
            position: absolute;
            top: 10px;
            left: 10px;
            background: #2a5298;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 100;
            text-decoration: none;
        } 
        /* ===================== */
/* MOBILE RESPONSIVENESS */
/* ===================== */

/* Mobile Navigation Toggle */
.mobile-menu-toggle {
    display: none;
    position: fixed;
    top: 15px;
    left: 15px;
    background: #1e3c72;
    color: white;
    border: none;
    border-radius: 8px;
    width: 50px;
    height: 50px;
    z-index: 1001;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
}

.mobile-menu-toggle i {
    font-size: 22px;
}

/* Mobile overlay */
.mobile-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    z-index: 998;
}

/* Table responsiveness */
.table-responsive-wrapper {
    position: relative;
    width: 100%;
}

.table-scroll-indicator {
    display: none;
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(30, 60, 114, 0.9);
    color: white;
    padding: 8px 12px;
    border-radius: 20px;
    font-size: 12px;
    z-index: 5;
    pointer-events: none;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 0.7; }
    50% { opacity: 1; }
}

/* Card adjustments for mobile */
.stat-card {
    flex-wrap: wrap;
}

/* Action buttons container */
.action-buttons-container {
    min-width: 150px;
}

/* ===================== */
/* RESPONSIVE BREAKPOINTS */
/* ===================== */

/* Large tablets and small laptops */
@media (max-width: 1200px) {
    .sidebar {
        width: 220px;
    }
    .main-content {
        margin-left: 220px;
    }
    .stats-cards {
        grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
    }
    th, td {
        padding: 12px 10px;
    }
}

/* Tablets */
@media (max-width: 992px) {
    .mobile-menu-toggle {
        display: flex;
    }
    
    .mobile-overlay.active {
        display: block;
    }
    
    .sidebar {
        transform: translateX(-100%);
        transition: transform 0.3s ease;
        width: 280px;
        z-index: 999;
        box-shadow: 2px 0 15px rgba(0,0,0,0.1);
    }
    
    .sidebar.active {
        transform: translateX(0);
    }
    
    .logo h2 span,
    .nav-item span {
        display: block !important;
    }
    
    .nav-item {
        justify-content: flex-start !important;
        padding: 15px 20px !important;
    }
    
    .main-content {
        margin-left: 0;
        padding: 20px 15px;
    }
    
    .header {
        margin-top: 60px;
    }
    
    .config-panel {
        margin: 15px;
    }
    
    .config-input {
        flex-direction: column;
    }
    
    .config-input input {
        min-width: 100%;
    }
    
    .table-scroll-indicator {
        display: block;
    }
}

/* Large phones */
@media (max-width: 768px) {
    .stats-cards {
        grid-template-columns: 1fr;
        gap: 15px;
    }
    
    .header {
        flex-direction: column;
        align-items: stretch;
        gap: 15px;
        margin-bottom: 20px;
    }
    
    .header h1 {
        font-size: 1.5rem;
        text-align: center;
    }
    
    .header > div {
        display: flex;
        flex-direction: column;
        gap: 10px;
        width: 100%;
    }
    
    .action-btn {
        width: 100%;
        justify-content: center;
        padding: 10px 15px;
    }
    
    .refresh-btn, .export-btn {
        margin-left: 0 !important;
        width: 100%;
    }
    
    .agents-table-container {
        padding: 15px;
        margin: 15px -15px;
        border-radius: 0;
        width: calc(100% + 30px);
    }
    
    table {
        min-width: 800px;
    }
    
    .action-buttons {
        flex-direction: column;
        gap: 8px;
        min-width: 120px;
    }
    
    .modal {
        padding: 10px;
    }
    
    .modal-content {
        max-height: 95vh;
    }
    
    .agent-details {
        grid-template-columns: 1fr;
        gap: 15px;
    }
    
    .photos-grid {
        grid-template-columns: 1fr;
    }
    
    .photo-container img,
    .image-placeholder {
        height: 220px;
    }
    
    .verification-actions {
        flex-direction: column;
    }
    
    .verification-actions .action-btn {
        width: 100%;
    }
    
    .detail-value {
        font-size: 15px;
        min-height: 40px;
    }
}

/* Medium phones */
@media (max-width: 576px) {
    .mobile-menu-toggle,
    .config-toggle,
    .home-link {
        width: 46px;
        height: 46px;
    }
    
    .home-link {
        top: 70px;
        left: 15px;
    }
    
    .config-toggle {
        top: 15px;
        right: 70px;
    }
    
    .main-content {
        padding: 15px 10px;
    }
    
    .header {
        margin-top: 50px;
    }
    
    .header h1 {
        font-size: 1.4rem;
    }
    
    .card {
        padding: 20px;
    }
    
    .stat-card {
        flex-direction: row;
        text-align: left;
    }
    
    .stat-icon {
        width: 50px;
        height: 50px;
        font-size: 20px;
        flex-shrink: 0;
    }
    
    .stat-info h3 {
        font-size: 24px;
    }
    
    .stat-info p {
        font-size: 14px;
    }
    
    .agents-table-container {
        margin: 10px -10px;
        width: calc(100% + 20px);
        padding: 12px;
    }
    
    table {
        min-width: 700px;
    }
    
    th, td {
        padding: 10px 8px;
        font-size: 13px;
    }
    
    .status {
        padding: 4px 8px;
        font-size: 11px;
    }
    
    .modal-header {
        padding: 15px;
    }
    
    .modal-header h2 {
        font-size: 1.3rem;
    }
    
    .modal-body {
        padding: 15px;
    }
    
    .close-modal {
        width: 36px;
        height: 36px;
        font-size: 22px;
    }
    
    .detail-label {
        font-size: 12px;
    }
    
    .detail-value {
        font-size: 14px;
        padding: 8px;
    }
    
    .photo-container img,
    .image-placeholder {
        height: 180px;
    }
    
    .no-data {
        padding: 30px 15px;
    }
    
    .no-data i {
        font-size: 40px;
    }
    
    .no-data h3 {
        font-size: 1.2rem;
    }
    
    .no-data p {
        font-size: 14px;
    }
}

/* Small phones */
@media (max-width: 400px) {
    .mobile-menu-toggle,
    .config-toggle,
    .home-link {
        width: 42px;
        height: 42px;
    }
    
    .home-link {
        top: 65px;
    }
    
    .config-toggle {
        right: 65px;
    }
    
    .header h1 {
        font-size: 1.3rem;
    }
    
    .stats-cards {
        gap: 12px;
    }
    
    .card {
        padding: 18px;
    }
    
    .stat-icon {
        width: 45px;
        height: 45px;
    }
    
    .stat-info h3 {
        font-size: 22px;
    }
    
    table {
        min-width: 650px;
    }
    
    th, td {
        padding: 8px 6px;
        font-size: 12px;
    }
    
    .action-btn {
        padding: 8px 12px;
        font-size: 12px;
    }
    
    .modal {
        padding: 5px;
    }
    
    .modal-header {
        padding: 12px;
    }
    
    .modal-body {
        padding: 12px;
    }
    
    .photo-container img,
    .image-placeholder {
        height: 160px;
    }
    
    .image-placeholder i {
        font-size: 30px;
    }
}

/* Extra small devices */
@media (max-width: 360px) {
    .sidebar {
        width: 260px;
    }
    
    .nav-item {
        padding: 12px 16px !important;
        font-size: 14px;
    }
    
    .nav-item i {
        font-size: 16px;
        width: 18px;
    }
    
    .stat-card {
        flex-direction: column;
        text-align: center;
        gap: 10px;
    }
    
    .stat-info {
        width: 100%;
    }
    
    .stat-info h3 {
        font-size: 26px;
    }
    
    .header h1 {
        font-size: 1.2rem;
    }
    
    .action-btn span {
        display: none;
    }
    
    .action-btn i {
        margin-right: 0;
    }
}

/* Landscape orientation */
@media (max-height: 600px) and (orientation: landscape) {
    .sidebar {
        overflow-y: auto;
        padding-top: 60px;
    }
    
    .logo {
        display: none;
    }
    
    .modal-content {
        max-height: 85vh;
    }
    
    .photo-container img,
    .image-placeholder {
        height: 150px;
    }
}

/* Print styles */
@media print {
    .sidebar,
    .mobile-menu-toggle,
    .mobile-overlay,
    .config-toggle,
    .home-link,
    .action-buttons,
    .verification-panel,
    .refresh-btn,
    .export-btn,
    .table-scroll-indicator {
        display: none !important;
    }
    
    .main-content {
        margin-left: 0;
        padding: 0;
    }
    
    body {
        background: white;
    }
    
    .card, .agents-table-container {
        box-shadow: none;
        border: 1px solid #ddd;
        break-inside: avoid;
    }
    
    .modal {
        position: static;
        background: white;
    }
    
    .modal-content {
        max-width: 100%;
        box-shadow: none;
    }
    }
    </style>
</head>
<body>
    <!-- Home Link -->
    <a href="index.html" class="home-link" title="Go to Registration Form">
        <i class="fas fa-home"></i>
    </a>
    
    <!-- Config Toggle Button -->
    <button class="config-toggle" id="configToggle">
        <i class="fas fa-cog"></i>
    </button>
    
    <div class="sidebar">
        <div class="logo">
            <h2><i class="fas fa-tachometer-alt"></i> <span>Admin Dashboard</span></h2>
        </div>
        
        <ul class="nav-menu">
            <li class="nav-item active" onclick="showSection('dashboard')">
                <i class="fas fa-home"></i>
                <span>Dashboard</span>
            </li>
            <li class="nav-item" onclick="showSection('agents')">
                <i class="fas fa-user-tie"></i>
                <span>Agents</span>
            </li>
        </ul>
        
        <!-- Configuration Panel -->
        <div class="config-panel" id="configPanel">
            <h3><i class="fas fa-database"></i> GitHub Configuration</h3>
            <p>Configure to read data from your GitHub repository:</p>
            <div class="config-input">
                <input type="text" id="repoOwner" placeholder="GitHub Username">
                <input type="text" id="repoName" placeholder="Repository Name">
                <input type="text" id="accessToken" placeholder="Access Token (optional for read)">
            </div>
            <div class="config-input">
                <input type="text" id="branchName" value="main" placeholder="Branch Name">
                <button class="config-btn" onclick="saveGitHubConfig()">Save Configuration</button>
                <button class="config-btn" onclick="loadAgentData()">Load Data</button>
            </div>
            <p style="font-size: 12px; color: #666; margin-top: 10px;">
    <strong>Note:</strong> Data will be loaded from <code>data.json</code> in the root of your repository
</p>
        </div>
    </div>
    
    <div class="main-content">
        <!-- Dashboard Section -->
        <div id="dashboardSection">
            <div class="header">
                <h1>Agent Management Dashboard</h1>
                <div>
                    <button class="action-btn verify-btn refresh-btn" onclick="loadAgentData()">
                        <i class="fas fa-sync-alt"></i> Refresh Data
                    </button>
                    <!-- ADD THIS BUTTON -->
        <button class="action-btn email-btn" onclick="setAgentPassword()" style="margin-left: 10px;">
            <i class="fas fa-key"></i> Set Agent Password
        </button>
        <button class="action-btn view-btn" onclick="viewAgentPassword()" style="margin-left: 10px;">
    <i class="fas fa-eye"></i> View Password
</button>
<button class="action-btn delete-btn" onclick="resetAgentPassword()" style="margin-left: 10px;">
    <i class="fas fa-trash"></i> Reset Password
</button>
                </div>
            </div>
            
            <div class="stats-cards">
                <div class="card stat-card">
                    <div class="stat-icon stat-1">
                        <i class="fas fa-user-tie"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="totalAgents">0</h3>
                        <p>Total Agents</p>
                    </div>
                </div>
                
                <div class="card stat-card">
                    <div class="stat-icon stat-2">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="verifiedAgents">0</h3>
                        <p>Verified Agents</p>
                    </div>
                </div>
                
                <div class="card stat-card">
                    <div class="stat-icon stat-3">
                        <i class="fas fa-hourglass-half"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="pendingAgents">0</h3>
                        <p>Pending Verification</p>
                    </div>
                </div>
                
                <div class="card stat-card">
                    <div class="stat-icon stat-4">
                        <i class="fas fa-envelope"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="emailPending">0</h3>
                        <p>Email Verification Pending</p>
                    </div>
                </div>
            </div>
            
            <div class="agents-table-container">
                <h2 style="color: #1e3c72; margin-bottom: 20px;">Recent Agent Submissions</h2>
                
                <div id="recentAgentsTable">
                    <div class="no-data" id="noRecentData">
                        <i class="fas fa-user-slash"></i>
                        <h3>No Agent Submissions Yet</h3>
                        <p>Click "Load Data" to fetch from data.json</p>
                    </div>
                    <table style="display: none;" id="recentTable">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Status</th>
                                <th>Date Submitted</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="recentTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- All Agents Section -->
        <div id="agentsSection" style="display: none;">
            <div class="header">
                <h1>All Agent Submissions</h1>
                <div>
                    <button class="action-btn verify-btn refresh-btn" onclick="loadAgentData()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
            </div>
            
            <div class="agents-table-container">
                <div id="allAgentsTable">
                    <div class="no-data" id="noAgentsData">
                        <i class="fas fa-user-slash"></i>
                        <h3>No Agent Submissions Yet</h3>
                        <p>Click "Load Data" to fetch from data.json</p>
                    </div>
                    <table style="display: none;" id="allAgentsTableElement">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>Status</th>
                                <th>Email Verified</th>
                                <th>Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="allAgentsTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Agent Details Modal -->
    <div class="modal" id="agentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Agent Details</h2>
                <button class="close-modal" id="closeModal">&times;</button>
            </div>
            <div class="modal-body" id="agentModalBody">
                <!-- Agent details will be loaded here -->
            </div>
        </div>
    </div>

    <script>
        // GitHub Configuration - ALL FILES ARE IN /data FOLDER
        
        let githubConfig = {
    repoOwner: 'BarasaGodwilTech',
    repoName: 'Ezee-money',
    accessToken: '',
    branchName: 'main'
    // Remove dataFolder since files are in root
};
        
        // Data storage
        let agents = [];
        let dataJson = null;
        
        // DOM Elements
        const configToggle = document.getElementById('configToggle');
        const configPanel = document.getElementById('configPanel');
        const dashboardSection = document.getElementById('dashboardSection');
        const agentsSection = document.getElementById('agentsSection');
        
        // Stats elements
        const totalAgentsEl = document.getElementById('totalAgents');
        const verifiedAgentsEl = document.getElementById('verifiedAgents');
        const pendingAgentsEl = document.getElementById('pendingAgents');
        const emailPendingEl = document.getElementById('emailPending');
        
        // Modal elements
        const agentModal = document.getElementById('agentModal');
        const closeModalBtn = document.getElementById('closeModal');
        const agentModalBody = document.getElementById('agentModalBody');
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadGitHubConfig();
            setupEventListeners();
            
            // Try to load data immediately if config exists
            if (githubConfig.repoOwner && githubConfig.repoName) {
                loadAgentData();
            }
        });
        
        function setupEventListeners() {
            // Config toggle
            configToggle.addEventListener('click', () => {
                configPanel.style.display = configPanel.style.display === 'block' ? 'none' : 'block';
            });
            
            // Modal close
            closeModalBtn.addEventListener('click', () => {
                agentModal.style.display = 'none';
            });
            
            window.addEventListener('click', (e) => {
                if (e.target === agentModal) {
                    agentModal.style.display = 'none';
                }
            });
        }
        
        // Load GitHub configuration
        function loadGitHubConfig() {
            const savedConfig = localStorage.getItem('githubConfig');
            if (savedConfig) {
                githubConfig = JSON.parse(savedConfig);
                
                // Update form fields
                document.getElementById('repoOwner').value = githubConfig.repoOwner || '';
                document.getElementById('repoName').value = githubConfig.repoName || '';
                document.getElementById('accessToken').value = githubConfig.accessToken || '';
                document.getElementById('branchName').value = githubConfig.branchName || 'main';
            } else {
                // Set defaults based on your screenshot
                document.getElementById('repoOwner').value = 'BarasaGodwilTech';
                document.getElementById('repoName').value = 'Ezee-money';
                document.getElementById('branchName').value = 'main';
            }
        }
        
        function saveGitHubConfig() {
            githubConfig.repoOwner = document.getElementById('repoOwner').value.trim();
            githubConfig.repoName = document.getElementById('repoName').value.trim();
            githubConfig.accessToken = document.getElementById('accessToken').value.trim();
            githubConfig.branchName = document.getElementById('branchName').value.trim() || 'main';
            
            localStorage.setItem('githubConfig', JSON.stringify(githubConfig));
            alert('GitHub configuration saved!');
            configPanel.style.display = 'none';
            
            // Try to load data with new config
            loadAgentData();
        }
        
        // Load agent data from GitHub
        async function loadAgentData() {
            try {
                // Show loading state
                const refreshBtn = document.querySelector('.refresh-btn');
                const originalText = refreshBtn.innerHTML;
                refreshBtn.innerHTML = '<span class="loading"></span> Loading...';
                refreshBtn.disabled = true;
                
                // Load from GitHub
                dataJson = await fetchGitHubData();
                agents = dataJson.agents || [];
                
                console.log(`Loaded ${agents.length} agents from GitHub`);
                updateDashboard();
                renderRecentAgents();
                renderAllAgents();
                
                // Save a copy to localStorage for offline access
                localStorage.setItem('dataJson', JSON.stringify(dataJson));
                
                refreshBtn.innerHTML = originalText;
                refreshBtn.disabled = false;
                
            } catch (error) {
                console.error('Error loading agent data:', error);
                
                // Try to load from localStorage as fallback
                try {
                    const storedData = localStorage.getItem('dataJson');
                    if (storedData) {
                        dataJson = JSON.parse(storedData);
                        agents = dataJson.agents || [];
                        
                        console.log(`Loaded ${agents.length} agents from localStorage`);
                        updateDashboard();
                        renderRecentAgents();
                        renderAllAgents();
                        
                        alert('Loaded from local cache. GitHub connection failed: ' + error.message);
                    } else {
                        // No data available
                        agents = [];
                        updateDashboard();
                        renderRecentAgents();
                        renderAllAgents();
                        alert('Failed to load data: ' + error.message);
                    }
                } catch (localError) {
                    alert('Failed to load data: ' + error.message);
                }
                
                const refreshBtn = document.querySelector('.refresh-btn');
                refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh Data';
                refreshBtn.disabled = false;
            }
        }
        
        // Fetch data from GitHub
        async function fetchGitHubData() {
            if (!githubConfig.repoOwner || !githubConfig.repoName) {
                throw new Error('GitHub repository not configured');
            }
            
            // Since all files are in /data folder, data.json is at /data/data.json
            const filepath = `data.json`;
            const apiUrl = `https://api.github.com/repos/${githubConfig.repoOwner}/${githubConfig.repoName}/contents/${filepath}?ref=${githubConfig.branchName}`;
            
            const headers = {
                'Accept': 'application/vnd.github.v3+json'
            };
            
            // Add authorization if available (not required for public repos, but helps with rate limits)
            if (githubConfig.accessToken) {
                headers['Authorization'] = `token ${githubConfig.accessToken}`;
            }
            
            const response = await fetch(apiUrl, { headers });
            
            if (!response.ok) {
                throw new Error(`Failed to fetch data: ${response.statusText}`);
            }
            
            const data = await response.json();
            
            // Decode base64 content
            const jsonContent = decodeURIComponent(escape(atob(data.content)));
            
            return JSON.parse(jsonContent);
        }

        // ==================== AGENT PASSWORD MANAGEMENT ====================

// Set password for field agents
// Set password for field agents
async function setAgentPassword() {
    // Ask for password
    const password = prompt('Enter a password for field agents to use for authentication:');
    
    if (!password || password.length < 4) {
        alert('Password must be at least 4 characters long.');
        return;
    }
    
    // Ask for confirmation
    const confirmPassword = prompt('Confirm the password:');
    
    if (password !== confirmPassword) {
        alert('Passwords do not match. Please try again.');
        return;
    }
    
    // Create hash
    const hash = await createSHA256Hash(password);
    
    try {
        // Create complete config object
        const configData = {
            security: {
                agentPasswordHash: hash,
                passwordSetAt: new Date().toISOString(),
                passwordSetBy: "admin"
            },
            github: {
                repoOwner: githubConfig.repoOwner,
                repoName: githubConfig.repoName,
                branchName: githubConfig.branchName,
                imagesFolder: "images"
            },
            system: {
                appName: "Ezee Money Agent Registration",
                version: "1.0.0",
                requiresAuthentication: true
            }
        };
        
        // Save to GitHub
        await saveConfigToGitHub(configData);
        
        alert('✅ Agent password has been set!\n\nPassword: ' + password + 
              '\n\nShare this password with your field agents.\nThey will use it to authenticate.');
        
    } catch (error) {
        console.error('Error saving password:', error);
        alert('Error saving password: ' + error.message);
    }
}

async function saveConfigToGitHub(configData) {
    const filepath = `config.json`;
    const apiUrl = `https://api.github.com/repos/${githubConfig.repoOwner}/${githubConfig.repoName}/contents/${filepath}`;
    
    const headers = {
        'Content-Type': 'application/json',
        'Accept': 'application/vnd.github.v3+json',
        'Authorization': `token ${githubConfig.accessToken}`
    };
    
    // Convert to JSON and base64
    const jsonContent = JSON.stringify(configData, null, 2);
    const contentBase64 = btoa(unescape(encodeURIComponent(jsonContent)));
    
    // Get SHA if file exists
    let sha = null;
    try {
        const fileInfo = await fetch(apiUrl, { headers });
        if (fileInfo.ok) {
            const fileData = await fileInfo.json();
            sha = fileData.sha;
        }
    } catch (error) {
        // File doesn't exist yet
    }
    
    const body = {
        message: `Update agent password configuration`,
        content: contentBase64,
        branch: githubConfig.branchName
    };
    
    if (sha) body.sha = sha;
    
    const response = await fetch(apiUrl, {
        method: 'PUT',
        headers: headers,
        body: JSON.stringify(body)
    });
    
    if (!response.ok) {
        const errorData = await response.json();
        throw new Error(`GitHub API error: ${errorData.message || response.statusText}`);
    }
    
    return await response.json();
}
async function createAndSaveConfig() {
    const password = prompt('Enter agent password (min 6 characters):');
    
    if (!password || password.length < 6) {
        alert('Password must be at least 6 characters long.');
        return;
    }
    
    // Create SHA-256 hash
    const hash = await createSHA256Hash(password);
    
    // Create config object
    const configData = {
        security: {
            agentPasswordHash: hash,
            passwordSetAt: new Date().toISOString(),
            passwordSetBy: "admin"
        },
        github: {
            repoOwner: githubConfig.repoOwner,
            repoName: githubConfig.repoName,
            branchName: githubConfig.branchName,
            imagesFolder: "images"
        },
        system: {
            appName: "Ezee Money Agent Registration",
            version: "1.0.0"
        }
    };
    
    try {
        await saveConfigToGitHub(configData);
        alert('✅ Configuration saved successfully!\n\nPassword has been set and saved to GitHub.\nShare this password with your field agents.');
    } catch (error) {
        alert('Error saving config: ' + error.message);
    }
}

// Helper function to create SHA-256 hash
async function createSHA256Hash(text) {
    // Encode the text
    const encoder = new TextEncoder();
    const data = encoder.encode(text);
    
    // Hash the data
    const hashBuffer = await crypto.subtle.digest('SHA-256', data);
    
    // Convert buffer to hex string
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    
    return hashHex;
}

// Function to save config to GitHub
async function saveConfigToGitHub(configData) {
    const filepath = `config.json`;
    const apiUrl = `https://api.github.com/repos/${githubConfig.repoOwner}/${githubConfig.repoName}/contents/${filepath}`;
    
    const headers = {
        'Content-Type': 'application/json',
        'Accept': 'application/vnd.github.v3+json',
        'Authorization': `token ${githubConfig.accessToken}`
    };
    
    // Convert to JSON and base64
    const jsonContent = JSON.stringify(configData, null, 2);
    const contentBase64 = btoa(unescape(encodeURIComponent(jsonContent)));
    
    // Get SHA if file exists
    let sha = null;
    try {
        const fileInfo = await fetch(apiUrl, { headers });
        if (fileInfo.ok) {
            const fileData = await fileInfo.json();
            sha = fileData.sha;
        }
    } catch (error) {
        // File doesn't exist yet
    }
    
    const body = {
        message: `Update system configuration`,
        content: contentBase64,
        branch: githubConfig.branchName
    };
    
    if (sha) body.sha = sha;
    
    const response = await fetch(apiUrl, {
        method: 'PUT',
        headers: headers,
        body: JSON.stringify(body)
    });
    
    if (!response.ok) {
        const errorData = await response.json();
        throw new Error(`GitHub API error: ${errorData.message || response.statusText}`);
    }
    
    return await response.json();
}

// View current agent password (admin only)
function viewAgentPassword() {
    const storedPassword = localStorage.getItem('agentPassword');
    
    if (!storedPassword) {
        alert('No agent password has been set yet.\n\nClick "Set Agent Password" to create one.');
        return;
    }
    
    const confirmView = confirm('Current agent password is: ' + storedPassword + 
                               '\n\nDo you want to copy this to clipboard?');
    
    if (confirmView) {
        navigator.clipboard.writeText(storedPassword).then(() => {
            alert('Password copied to clipboard!');
        }).catch(() => {
            // Fallback if clipboard API fails
            prompt('Copy this password:', storedPassword);
        });
    }
}

// Reset agent password
function resetAgentPassword() {
    const confirmReset = confirm('Are you sure you want to reset the agent password?\n\n' +
                               'All field agents will need to re-authenticate with the new password.');
    
    if (confirmReset) {
        localStorage.removeItem('agentPasswordHash');
        localStorage.removeItem('agentPassword');
        alert('Agent password has been reset.');
    }
}
        
        // Update dashboard statistics
        function updateDashboard() {
            totalAgentsEl.textContent = agents.length;
            
            const verifiedCount = agents.filter(a => a.status === 'verified' || a.status === 'complete').length;
            verifiedAgentsEl.textContent = verifiedCount;
            
            const pendingCount = agents.filter(a => a.status === 'pending').length;
            pendingAgentsEl.textContent = pendingCount;
            
            const emailPendingCount = agents.filter(a => !a.emailVerified).length;
            emailPendingEl.textContent = emailPendingCount;
        }
        
        // Render recent agents (last 5)
        function renderRecentAgents() {
            const recentTable = document.getElementById('recentTable');
            const recentTableBody = document.getElementById('recentTableBody');
            const noRecentData = document.getElementById('noRecentData');
            
            if (agents.length === 0) {
                recentTable.style.display = 'none';
                noRecentData.style.display = 'block';
                return;
            }
            
            recentTable.style.display = 'table';
            noRecentData.style.display = 'none';
            recentTableBody.innerHTML = '';
            
            // Get last 5 agents
            const recentAgents = [...agents].sort((a, b) => 
                new Date(b.submissionDate) - new Date(a.submissionDate)
            ).slice(0, 5);
            
            recentAgents.forEach(agent => {
                const row = document.createElement('tr');
                
                // Format date
                const submissionDate = new Date(agent.submissionDate);
                const formattedDate = submissionDate.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
                
                // Status badge
                let statusClass, statusText;
                if (agent.status === 'verified' || agent.status === 'complete') {
                    statusClass = 'status-verified';
                    statusText = 'Verified';
                } else {
                    statusClass = 'status-pending';
                    statusText = 'Pending';
                }
                
                row.innerHTML = `
                    <td>${agent.fullName}</td>
                    <td>${agent.email}</td>
                    <td><span class="status ${statusClass}">${statusText}</span></td>
                    <td>${formattedDate}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="action-btn view-btn" onclick="viewAgent('${agent.id}')">
                                <i class="fas fa-eye"></i> View
                            </button>
                            ${!agent.emailVerified ? `
                            <button class="action-btn verify-btn" onclick="sendVerificationEmail('${agent.id}')">
                                <i class="fas fa-envelope"></i> Send Email
                            </button>
                            ` : ''}
                        </div>
                    </td>
                `;
                
                recentTableBody.appendChild(row);
            });
        }
        
        // Render all agents
        function renderAllAgents() {
            const allAgentsTable = document.getElementById('allAgentsTableElement');
            const allAgentsTableBody = document.getElementById('allAgentsTableBody');
            const noAgentsData = document.getElementById('noAgentsData');
            
            if (agents.length === 0) {
                allAgentsTable.style.display = 'none';
                noAgentsData.style.display = 'block';
                return;
            }
            
            allAgentsTable.style.display = 'table';
            noAgentsData.style.display = 'none';
            allAgentsTableBody.innerHTML = '';
            
            // Sort by date (newest first)
            const sortedAgents = [...agents].sort((a, b) => 
                new Date(b.submissionDate) - new Date(a.submissionDate)
            );
            
            sortedAgents.forEach(agent => {
                const row = document.createElement('tr');
                
                // Format date
                const submissionDate = new Date(agent.submissionDate);
                const formattedDate = submissionDate.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
                
                // Status badge
                let statusClass, statusText;
                if (agent.status === 'verified' || agent.status === 'complete') {
                    statusClass = 'status-verified';
                    statusText = 'Verified';
                } else {
                    statusClass = 'status-pending';
                    statusText = 'Pending';
                }
                
                // Email verification status
                const emailStatus = agent.emailVerified ? 
                    '<span class="status status-verified">Yes</span>' : 
                    '<span class="status status-pending">No</span>';
                
                // Phone (extract from next of kin or use placeholder)
                const phone = agent.nextOfKinPhone || 'N/A';
                
                row.innerHTML = `
                    <td>${agent.id.substring(0, 10)}...</td>
                    <td>${agent.fullName}</td>
                    <td>${agent.email}</td>
                    <td>${phone}</td>
                    <td><span class="status ${statusClass}">${statusText}</span></td>
                    <td>${emailStatus}</td>
                    <td>${formattedDate}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="action-btn view-btn" onclick="viewAgent('${agent.id}')">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="action-btn email-btn" onclick="sendVerificationEmail('${agent.id}')" ${agent.emailVerified ? 'disabled' : ''}>
                                <i class="fas fa-envelope"></i>
                            </button>
                            <button class="action-btn verify-btn" onclick="verifyAgent('${agent.id}')" ${agent.status === 'verified' || agent.status === 'complete' ? 'disabled' : ''}>
                                <i class="fas fa-check"></i>
                            </button>
                        </div>
                    </td>
                `;
                
                allAgentsTableBody.appendChild(row);
            });
        }
        
        // View agent details
        function viewAgent(agentId) {
            const agent = agents.find(a => a.id === agentId);
            
            if (!agent) {
                alert('Agent not found!');
                return;
            }
            
            // Format dates
            const submissionDate = new Date(agent.submissionDate);
            const formattedSubmissionDate = submissionDate.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            const dobDate = new Date(agent.dob);
            const formattedDob = dobDate.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            // Create agent details HTML
            let photosHTML = '';
            
            // Check if we have image URLs
            if (agent.idFrontUrl || agent.idBackUrl || agent.agentPhotoUrl) {
                photosHTML = `
                <div class="photo-section">
                    <h3 style="color: #1e3c72; margin-bottom: 15px;">Photos</h3>
                    <div class="photos-grid">
                        ${agent.idFrontUrl ? `
                        <div class="photo-container">
                            <img src="${agent.idFrontUrl}" alt="ID Front" onerror="this.parentElement.innerHTML='<div class=\\'image-placeholder\\'><i class=\\'fas fa-id-card\\' style=\\'font-size: 40px; margin-bottom: 10px;\\'></i><span>ID Front</span></div>'">
                            <div class="photo-label">ID Front / Passport Bio Page</div>
                        </div>
                        ` : '<div class="photo-container"><div class="image-placeholder"><i class="fas fa-id-card" style="font-size: 40px; margin-bottom: 10px;"></i><span>ID Front Not Available</span></div></div>'}
                        
                        ${agent.idBackUrl ? `
                        <div class="photo-container">
                            <img src="${agent.idBackUrl}" alt="ID Back" onerror="this.parentElement.innerHTML='<div class=\\'image-placeholder\\'><i class=\\'fas fa-id-card\\' style=\\'font-size: 40px; margin-bottom: 10px;\\'></i><span>ID Back</span></div>'">
                            <div class="photo-label">ID Back / Passport Cover</div>
                        </div>
                        ` : '<div class="photo-container"><div class="image-placeholder"><i class="fas fa-id-card" style="font-size: 40px; margin-bottom: 10px;"></i><span>ID Back Not Available</span></div></div>'}
                        
                        ${agent.agentPhotoUrl ? `
                        <div class="photo-container">
                            <img src="${agent.agentPhotoUrl}" alt="Agent Photo" onerror="this.parentElement.innerHTML='<div class=\\'image-placeholder\\'><i class=\\'fas fa-user\\' style=\\'font-size: 40px; margin-bottom: 10px;\\'></i><span>Agent Photo</span></div>'">
                            <div class="photo-label">Agent Passport Photo</div>
                        </div>
                        ` : '<div class="photo-container"><div class="image-placeholder"><i class="fas fa-user" style="font-size: 40px; margin-bottom: 10px;"></i><span>Agent Photo Not Available</span></div></div>'}
                    </div>
                </div>
                `;
            }
            
            agentModalBody.innerHTML = `
                <div class="agent-details">
                    <div>
                        <div class="detail-group">
                            <div class="detail-label">Full Name</div>
                            <div class="detail-value">${agent.fullName}</div>
                        </div>
                        
                        <div class="detail-group">
                            <div class="detail-label">Email</div>
                            <div class="detail-value">${agent.email}</div>
                        </div>
                        
                        <div class="detail-group">
                            <div class="detail-label">Personal Number</div>
                            <div class="detail-value">${agent.personalNumber}</div>
                        </div>
                        
                        <div class="detail-group">
                            <div class="detail-label">National ID</div>
                            <div class="detail-value">${agent.nationalId}</div>
                        </div>
                        
                        <div class="detail-group">
                            <div class="detail-label">Date of Birth</div>
                            <div class="detail-value">${formattedDob}</div>
                        </div>
                        
                        <div class="detail-group">
                            <div class="detail-label">Gender</div>
                            <div class="detail-value">${agent.gender ? agent.gender.charAt(0).toUpperCase() + agent.gender.slice(1) : 'Not specified'}</div>
                        </div>
                    </div>
                    
                    <div>
                        <div class="detail-group">
                            <div class="detail-label">Business Address</div>
                            <div class="detail-value">${agent.businessAddress}</div>
                        </div>
                        
                        <div class="detail-group">
                            <div class="detail-label">Residential Address</div>
                            <div class="detail-value">${agent.residentialAddress}</div>
                        </div>
                        
                        <div class="detail-group">
                            <div class="detail-label">Trading Name</div>
                            <div class="detail-value">${agent.tradingName || 'Not provided'}</div>
                        </div>
                        
                        <div class="detail-group">
                            <div class="detail-label">Submission Date</div>
                            <div class="detail-value">${formattedSubmissionDate}</div>
                        </div>
                        
                        <div class="detail-group">
                            <div class="detail-label">Status</div>
                            <div class="detail-value">
                                <span class="status ${agent.status === 'verified' || agent.status === 'complete' ? 'status-verified' : 'status-pending'}">
                                    ${agent.status === 'verified' || agent.status === 'complete' ? 'Verified' : 'Pending'}
                                </span>
                            </div>
                        </div>
                        
                        <div class="detail-group">
                            <div class="detail-label">Email Verified</div>
                            <div class="detail-value">
                                <span class="status ${agent.emailVerified ? 'status-verified' : 'status-pending'}">
                                    ${agent.emailVerified ? 'Yes' : 'No'}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 30px;">
                    <h3 style="color: #1e3c72; margin-bottom: 15px;">Next of Kin Information</h3>
                    <div class="agent-details">
                        <div class="detail-group">
                            <div class="detail-label">Full Name</div>
                            <div class="detail-value">${agent.nextOfKinName}</div>
                        </div>
                        
                        <div class="detail-group">
                            <div class="detail-label">Relationship</div>
                            <div class="detail-value">${agent.nextOfKinRelationship}</div>
                        </div>
                        
                        <div class="detail-group">
                            <div class="detail-label">Phone Number</div>
                            <div class="detail-value">${agent.nextOfKinPhone}</div>
                        </div>
                    </div>
                </div>
                
                ${photosHTML}
                
                ${!agent.emailVerified || agent.status === 'pending' ? `
                <div class="verification-panel">
                    <h3 style="color: #2e7d32; margin-bottom: 15px;">Verification Actions</h3>
                    <p>Use the buttons below to manage this agent's verification status.</p>
                    
                    <div class="verification-actions">
                        ${!agent.emailVerified ? `
                        <button class="action-btn email-btn" onclick="sendVerificationEmail('${agent.id}')">
                            <i class="fas fa-paper-plane"></i> Send Verification Email
                        </button>
                        ` : ''}
                        
                        ${agent.status === 'pending' ? `
                        <button class="action-btn verify-btn" onclick="verifyAgent('${agent.id}')">
                            <i class="fas fa-check-circle"></i> Mark as Verified
                        </button>
                        ` : ''}
                    </div>
                </div>
                ` : ''}
            `;
            
            // Show modal
            agentModal.style.display = 'flex';
        }
        
        // Send verification email
    
            
            // Send verification email
async function sendVerificationEmail(agentId) {
    const agent = agents.find(a => a.id === agentId);
    
    if (!agent) {
        alert('Agent not found!');
        return;
    }
    
    if (agent.emailVerified) {
        alert('This agent\'s email is already verified.');
        return;
    }
    
    // Create email template with the agent's details
    const subject = `Ezee Money Agent Registration - Email Verification`;
    
    const emailBody = `
Dear ${agent.fullName},

Welcome to Ezee Money!

We have received your agent registration with the following details:
- Full Name: ${agent.fullName}
- Personal Number: ${agent.personalNumber}
- National ID: ${agent.nationalId}
- Email: ${agent.email}

**About Ezee Money:**
Ezee Money is an electronic, digital, cashless, and secure method for making fast, on-device payments. As an Ezee Money agent, you will help clients make instant payments and earn commission on every transaction you facilitate.

**Next Steps:**
1. Please reply to this email confirming that this email address (${agent.email}) is correct and belongs to you.
2. Once confirmed, your agent account will be activated.
3. You will receive training materials and login credentials to start earning commissions.

**Benefits of being an Ezee Money Agent:**
✅ Earn commission on every transaction
✅ Secure digital payments platform
✅ Real-time transaction tracking
✅ 24/7 customer support
✅ Flexible working hours
✅ No minimum transaction requirements

**Verification Required:**
To complete your registration, please reply to this email with "YES" to confirm that:
1. This email address belongs to you
2. You have provided accurate information
3. You agree to the terms of service

If this email was sent in error or if you need to update your information, please reply with the correct details.

We're excited to have you join the Ezee Money family!

Best regards,
Ezee Money Agent Management Team
[Your Contact Information]
    `.trim();
    
    // Encode the email content for mailto link
    const encodedSubject = encodeURIComponent(subject);
    const encodedBody = encodeURIComponent(emailBody);
    
    // Create mailto link
    const mailtoLink = `mailto:${agent.email}?subject=${encodedSubject}&body=${encodedBody}`;
    
    // Ask admin to send the email
    const confirmSend = confirm(`Send verification email to ${agent.email}?\n\nClick OK to open your email app with a pre-filled message.\n\nAfter sending, wait for the agent to reply confirming their email address.`);
    
    if (!confirmSend) {
        return;
    }
    
    // Open email client
    window.open(mailtoLink, '_blank');
    
    // Ask admin if agent confirmed receipt via reply
    setTimeout(() => {
        const agentConfirmed = confirm(`Did the agent REPLY to your email confirming their email address (${agent.email})?\n\nCheck your email inbox for their reply, then:\n- Click OK if they replied confirming\n- Click Cancel if they haven't replied yet`);
        
        if (agentConfirmed) {
            // Mark email as verified
            agent.emailVerified = true;
            
            // Update the data in GitHub (if we have write access)
            updateAgentData().then(() => {
                // Update UI
                loadAgentData();
                
                alert(`✅ Email for ${agent.fullName} has been verified successfully!\n\nAgent status updated.`);
                
                // Refresh modal if open
                if (agentModal.style.display === 'flex') {
                    viewAgent(agentId);
                }
            });
        } else {
            // Ask if we need to update email
            const updateEmail = confirm(`The agent hasn't confirmed yet. Do you want to:\n\n- Click OK to try sending again later\n- Click Cancel to update their email address`);
            
            if (!updateEmail) {
                // Ask for correct email
                const newEmail = prompt(`Please enter the correct email address for ${agent.fullName}:`, agent.email);
                
                if (newEmail && newEmail.trim() && isValidEmail(newEmail.trim())) {
                    // Update email
                    agent.email = newEmail.trim();
                    
                    // Update the data in GitHub (if we have write access)
                    updateAgentData().then(() => {
                        // Update UI
                        loadAgentData();
                        
                        alert(`Email updated to ${newEmail}. You can now send a verification email to the new address.`);
                        
                        // Refresh modal if open
                        if (agentModal.style.display === 'flex') {
                            viewAgent(agentId);
                        }
                    });
                } else if (newEmail) {
                    alert('Please enter a valid email address.');
                }
            }
        }
    }, 1000); // Small delay to allow email app to open
}
        
        // Verify agent (mark as verified)
        async function verifyAgent(agentId) {
            const agent = agents.find(a => a.id === agentId);
            
            if (!agent) {
                alert('Agent not found!');
                return;
            }
            
            if (agent.status === 'verified' || agent.status === 'complete') {
                alert('This agent is already verified.');
                return;
            }
            
            // Check if email is verified
            if (!agent.emailVerified) {
                const proceed = confirm('This agent\'s email is not verified yet. Do you want to mark them as verified anyway?');
                if (!proceed) {
                    return;
                }
            }
            
            // Mark as verified
            agent.status = 'verified';
            
            // Update the data in GitHub (if we have write access)
            await updateAgentData();
            
            // Update UI
            loadAgentData();
            
            alert(`${agent.fullName} has been verified successfully!`);
            
            // Refresh modal if open
            if (agentModal.style.display === 'flex') {
                viewAgent(agentId);
            }
        }
        
        // Update agent data in GitHub
        async function updateAgentData() {
            if (!dataJson) {
                dataJson = {
                    agents: agents,
                    lastUpdated: new Date().toISOString()
                };
            } else {
                dataJson.agents = agents;
                dataJson.lastUpdated = new Date().toISOString();
            }
            
            // Save to localStorage
            localStorage.setItem('dataJson', JSON.stringify(dataJson));
            
            // Try to save to GitHub if we have write access (access token)
            if (githubConfig.repoOwner && githubConfig.repoName && githubConfig.accessToken) {
                try {
                    await saveDataToGitHub(dataJson);
                } catch (error) {
                    console.warn('Failed to update GitHub:', error);
                    alert('Note: Data saved locally but could not update GitHub (need write access).');
                }
            } else {
                alert('Note: Data saved locally. To update GitHub, add an access token with write permissions.');
            }
        }
        
        // Save data to GitHub
        async function saveDataToGitHub(data) {
            // Convert to JSON
            const jsonContent = JSON.stringify(data, null, 2);
            
            // Create base64 encoded content
            const contentBase64 = btoa(unescape(encodeURIComponent(jsonContent)));
            
            // Prepare API URL - data.json is in the same /data folder
            const filepath = `data.json`;
            const apiUrl = `https://api.github.com/repos/${githubConfig.repoOwner}/${githubConfig.repoName}/contents/${filepath}`;
            
            // Prepare headers
            const headers = {
                'Content-Type': 'application/json',
                'Accept': 'application/vnd.github.v3+json',
                'Authorization': `token ${githubConfig.accessToken}`
            };
            
            // Get the file SHA first
            let sha = null;
            try {
                const fileInfo = await fetch(apiUrl, { headers });
                if (fileInfo.ok) {
                    const fileData = await fileInfo.json();
                    sha = fileData.sha;
                }
            } catch (error) {
                // File doesn't exist yet
            }
            
            // Prepare request body
            const body = {
                message: `Update agent data - ${new Date().toLocaleDateString()}`,
                content: contentBase64,
                branch: githubConfig.branchName
            };
            
            // Add SHA if we're updating existing file
            if (sha) {
                body.sha = sha;
            }
            
            // Send request to GitHub API
            const response = await fetch(apiUrl, {
                method: 'PUT',
                headers: headers,
                body: JSON.stringify(body)
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`GitHub API error: ${errorData.message || response.statusText}`);
            }
            
            return await response.json();
        }
        
        // Navigation between sections
        function showSection(section) {
            // Update active nav item
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            if (section === 'dashboard') {
                document.querySelector('.nav-item:nth-child(1)').classList.add('active');
                dashboardSection.style.display = 'block';
                agentsSection.style.display = 'none';
            } else if (section === 'agents') {
                document.querySelector('.nav-item:nth-child(2)').classList.add('active');
                dashboardSection.style.display = 'none';
                agentsSection.style.display = 'block';
            }
        }
        
        // Email validation helper
        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }
        // Add Export to Excel button to the header
document.addEventListener('DOMContentLoaded', function() {
    // Create export button
    const exportBtn = document.createElement('button');
    exportBtn.className = 'action-btn verify-btn';
    exportBtn.innerHTML = '<i class="fas fa-file-excel"></i> Export to Excel';
    exportBtn.style.marginLeft = '10px';
    exportBtn.onclick = exportToExcel;
    
    // Find the header actions div and add the button
    const headerActions = document.querySelector('.header > div');
    if (headerActions) {
        headerActions.appendChild(exportBtn);
    }
});

// Export all agent data to Excel
function exportToExcel() {
    if (!agents || agents.length === 0) {
        alert('No data available to export.');
        return;
    }
    
    // Show loading
    const originalText = event.target.innerHTML;
    event.target.innerHTML = '<span class="loading"></span> Exporting...';
    event.target.disabled = true;
    
    try {
        // Create CSV content
        let csvContent = "data:text/csv;charset=utf-8,";
        
        // Create headers
        const headers = [
            "Agent ID",
            "Full Name",
            "Email",
            "Email Verified",
            "Personal Number",
            "National ID",
            "Date of Birth",
            "Gender",
            "Business Address",
            "Residential Address",
            "Next of Kin Name",
            "Next of Kin Relationship",
            "Next of Kin Phone",
            "Trading Name",
            "Status",
            "Submission Date",
            "Admin Verified",
            "ID Front URL",
            "ID Back URL",
            "Agent Photo URL"
        ];
        
        csvContent += headers.join(",") + "\n";
        
        // Add data rows
        agents.forEach(agent => {
            const row = [
                `"${agent.id || ''}"`,
                `"${agent.fullName || ''}"`,
                `"${agent.email || ''}"`,
                `"${agent.emailVerified ? 'Yes' : 'No'}"`,
                `"${agent.personalNumber || ''}"`,
                `"${agent.nationalId || ''}"`,
                `"${agent.dob || ''}"`,
                `"${agent.gender || ''}"`,
                `"${(agent.businessAddress || '').replace(/"/g, '""')}"`,
                `"${(agent.residentialAddress || '').replace(/"/g, '""')}"`,
                `"${agent.nextOfKinName || ''}"`,
                `"${agent.nextOfKinRelationship || ''}"`,
                `"${agent.nextOfKinPhone || ''}"`,
                `"${agent.tradingName || ''}"`,
                `"${agent.status || ''}"`,
                `"${agent.submissionDate || ''}"`,
                `"${agent.adminVerified ? 'Yes' : 'No'}"`,
                `"${agent.idFrontUrl || ''}"`,
                `"${agent.idBackUrl || ''}"`,
                `"${agent.agentPhotoUrl || ''}"`
            ];
            csvContent += row.join(",") + "\n";
        });
        
        // Create download link
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        
        // Generate filename with current date
        const date = new Date();
        const dateStr = date.toISOString().split('T')[0];
        const timeStr = date.toTimeString().split(' ')[0].replace(/:/g, '-');
        link.setAttribute("download", `EzeeMoney_Agents_${dateStr}_${timeStr}.csv`);
        
        // Trigger download
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        // Show success message
        alert(`✅ Exported ${agents.length} agents to Excel (CSV) file.\n\nFile saved as: EzeeMoney_Agents_${dateStr}_${timeStr}.csv`);
        
    } catch (error) {
        console.error('Export error:', error);
        alert('Error exporting data: ' + error.message);
    } finally {
        // Reset button
        event.target.innerHTML = originalText;
        event.target.disabled = false;
    }
}

// Add CSS for the export button
const exportStyles = document.createElement('style');
exportStyles.textContent = `
    .export-btn {
        background-color: #2e7d32 !important;
        color: white !important;
    }
    
    .export-btn:hover {
        background-color: #1b5e20 !important;
    }
    
    @media (max-width: 768px) {
        .header > div {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .export-btn {
            width: 100%;
            margin-left: 0 !important;
        }
    }
`;
document.head.appendChild(exportStyles);

        // =============================
// MOBILE RESPONSIVENESS SCRIPT
// =============================

// Create mobile menu toggle button
const mobileToggleBtn = document.createElement('button');
mobileToggleBtn.className = 'mobile-menu-toggle';
mobileToggleBtn.innerHTML = '<i class="fas fa-bars"></i>';
document.body.appendChild(mobileToggleBtn);

// Create mobile overlay
const mobileOverlay = document.createElement('div');
mobileOverlay.className = 'mobile-overlay';
document.body.appendChild(mobileOverlay);

// Create table scroll indicator
const tableScrollIndicator = document.createElement('div');
tableScrollIndicator.className = 'table-scroll-indicator';
tableScrollIndicator.innerHTML = '<i class="fas fa-arrow-left"></i> Scroll';
document.body.appendChild(tableScrollIndicator);

// Toggle mobile sidebar
mobileToggleBtn.addEventListener('click', () => {
    document.querySelector('.sidebar').classList.toggle('active');
    mobileOverlay.classList.toggle('active');
    document.body.style.overflow = 'hidden';
});

// Close sidebar when clicking overlay
mobileOverlay.addEventListener('click', () => {
    document.querySelector('.sidebar').classList.remove('active');
    mobileOverlay.classList.remove('active');
    document.body.style.overflow = '';
});

// Close sidebar when clicking a nav item
document.querySelectorAll('.nav-item').forEach(item => {
    item.addEventListener('click', () => {
        if (window.innerWidth <= 992) {
            document.querySelector('.sidebar').classList.remove('active');
            mobileOverlay.classList.remove('active');
            document.body.style.overflow = '';
        }
    });
});

// Handle table horizontal scrolling
const agentsTable = document.querySelector('.agents-table-container');
if (agentsTable) {
    agentsTable.addEventListener('scroll', () => {
        const scrollLeft = agentsTable.scrollLeft;
        const maxScroll = agentsTable.scrollWidth - agentsTable.clientWidth;
        
        if (scrollLeft > 10 && scrollLeft < maxScroll - 10) {
            tableScrollIndicator.style.display = 'block';
            tableScrollIndicator.innerHTML = '<i class="fas fa-arrow-left"></i> <i class="fas fa-arrow-right"></i> Scroll';
        } else if (scrollLeft > 10) {
            tableScrollIndicator.style.display = 'block';
            tableScrollIndicator.innerHTML = '<i class="fas fa-arrow-left"></i> Scroll';
        } else if (scrollLeft < maxScroll - 10) {
            tableScrollIndicator.style.display = 'block';
            tableScrollIndicator.innerHTML = '<i class="fas fa-arrow-right"></i> Scroll';
        } else {
            tableScrollIndicator.style.display = 'none';
        }
        
        // Position indicator
        const rect = agentsTable.getBoundingClientRect();
        tableScrollIndicator.style.top = `${rect.top + rect.height / 2}px`;
    });
}

// Update table scroll indicator position on resize
window.addEventListener('resize', () => {
    if (agentsTable && tableScrollIndicator.style.display === 'block') {
        const rect = agentsTable.getBoundingClientRect();
        tableScrollIndicator.style.top = `${rect.top + rect.height / 2}px`;
    }
});

// Auto-close sidebar on larger screens
window.addEventListener('resize', () => {
    if (window.innerWidth > 992) {
        document.querySelector('.sidebar').classList.remove('active');
        mobileOverlay.classList.remove('active');
        document.body.style.overflow = '';
        tableScrollIndicator.style.display = 'none';
    }
});

// Close modals on Escape key
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        document.querySelector('.modal').style.display = 'none';
    }
});

// Make sure export button is responsive
document.addEventListener('DOMContentLoaded', () => {
    // Add export button class if exists
    const exportBtn = document.querySelector('.action-btn[onclick*="exportToExcel"]');
    if (exportBtn) {
        exportBtn.classList.add('export-btn');
    }
    
    // Make all buttons in header responsive
    const headerActions = document.querySelector('.header > div');
    if (headerActions) {
        headerActions.style.display = 'flex';
        headerActions.style.flexWrap = 'wrap';
        headerActions.style.gap = '10px';
        headerActions.style.alignItems = 'center';
    }
});

// Add touch swipe support for mobile
let touchStartX = 0;
let touchEndX = 0;

agentsTable?.addEventListener('touchstart', (e) => {
    touchStartX = e.changedTouches[0].screenX;
});

agentsTable?.addEventListener('touchend', (e) => {
    touchEndX = e.changedTouches[0].screenX;
    handleSwipe();
});

function handleSwipe() {
    const swipeThreshold = 50;
    
    if (touchEndX < touchStartX - swipeThreshold) {
        // Swipe left - scroll right
        agentsTable.scrollBy({ left: 200, behavior: 'smooth' });
    }
    
    if (touchEndX > touchStartX + swipeThreshold) {
        // Swipe right - scroll left
        agentsTable.scrollBy({ left: -200, behavior: 'smooth' });
    }
}

// Initialize on load
window.addEventListener('load', () => {
    // Update any existing UI for mobile
    if (window.innerWidth <= 768) {
        document.querySelectorAll('.action-btn').forEach(btn => {
            btn.style.padding = '10px 12px';
        });
    }
});
        // ================= AUTO-SYNC SYSTEM =================
        // Auto-refresh data every 4 seconds
setInterval(() => {
    const refreshBtn = document.querySelector('.refresh-btn');
    if (refreshBtn && !refreshBtn.disabled) {
        refreshBtn.click();
    }
}, 4000);
    
    </script>
    <script>
// ==================== FIXED PASSWORD MANAGEMENT ====================
// Override the broken viewPassword and resetPassword functions

// Fix 1: View Password - Show the actual password from config.json
async function viewAgentPassword() {
    try {
        if (!githubConfig.repoOwner || !githubConfig.repoName) {
            alert('Please configure GitHub settings first.');
            return;
        }
        
        // Show loading
        alert('Fetching current password from GitHub...');
        
        // Fetch the config file from GitHub
        const configData = await fetchConfigFromGitHub();
        
        if (!configData || !configData.security || !configData.security.agentPasswordHash) {
            alert('No password has been set yet.\n\nClick "Set Agent Password" to create one.');
            return;
        }
        
        // Since we can't reverse the hash, we need to ask admin if they remember it
        // This is more secure than storing plain text password
        const checkPassword = prompt('For security, we cannot retrieve the actual password.\n\n' +
                                   'To verify the current password, enter it below:');
        
        if (checkPassword) {
            const hash = await createSHA256Hash(checkPassword);
            if (hash === configData.security.agentPasswordHash) {
                alert('✅ Password is correct: ' + checkPassword + '\n\nMake note of this password for field agents.');
            } else {
                alert('❌ Incorrect password. The stored password is different.');
            }
        }
        
    } catch (error) {
        console.error('Error viewing password:', error);
        alert('Error fetching password: ' + error.message);
    }
}

// Fix 2: Reset Password - Actually remove from GitHub, not localStorage
async function resetAgentPassword() {
    const confirmReset = confirm('⚠️ WARNING: This will completely remove the agent password!\n\n' +
                               'All field agents will be locked out and must authenticate with a new password.\n\n' +
                               'Are you absolutely sure?');
    
    if (!confirmReset) {
        return;
    }
    
    try {
        if (!githubConfig.repoOwner || !githubConfig.repoName || !githubConfig.accessToken) {
            alert('GitHub access token required. Please configure in settings.');
            return;
        }
        
        // Show loading
        alert('Removing password from GitHub...');
        
        // Fetch current config
        let configData;
        try {
            configData = await fetchConfigFromGitHub();
        } catch (error) {
            configData = {};
        }
        
        // Remove password hash
        if (configData.security) {
            delete configData.security.agentPasswordHash;
            configData.security.passwordResetAt = new Date().toISOString();
            configData.security.passwordResetBy = 'admin';
        }
        
        // Save back to GitHub
        await saveConfigToGitHub(configData);
        
        // Also clear any local storage
        localStorage.removeItem('agentPasswordHash');
        
        alert('✅ Password has been successfully reset.\n\n' +
              'Field agents can no longer authenticate.\n' +
              'Set a new password using the "Set Agent Password" button.');
        
    } catch (error) {
        console.error('Error resetting password:', error);
        alert('Error resetting password: ' + error.message);
    }
}

// Helper function to fetch config from GitHub (duplicate of existing but ensure it works)
async function fetchConfigFromGitHub() {
    const filepath = `config.json`;
    const apiUrl = `https://api.github.com/repos/${githubConfig.repoOwner}/${githubConfig.repoName}/contents/${filepath}?ref=${githubConfig.branchName}`;
    
    const headers = {
        'Accept': 'application/vnd.github.v3+json'
    };
    
    if (githubConfig.accessToken) {
        headers['Authorization'] = `token ${githubConfig.accessToken}`;
    }
    
    const response = await fetch(apiUrl, { headers });
    
    if (!response.ok) {
        if (response.status === 404) {
            return { security: {}, github: {} };
        }
        throw new Error(`Failed to fetch config: ${response.statusText}`);
    }
    
    const data = await response.json();
    const jsonContent = decodeURIComponent(escape(atob(data.content)));
    return JSON.parse(jsonContent);
}

// Ensure createSHA256Hash is available
if (typeof createSHA256Hash !== 'function') {
    window.createSHA256Hash = async function(text) {
        const encoder = new TextEncoder();
        const data = encoder.encode(text);
        const hashBuffer = await crypto.subtle.digest('SHA-256', data);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    };
}

console.log('✅ Password management functions fixed!');
    </script>
    <!-- ============ FIELD AGENT TRACKING + NOTIFICATIONS + DELETE FUNCTION ============ -->
<script>
// ==================== FIELD AGENT TRACKING ====================
// Track active field agents and their activity
let activeFieldAgents = [];
let lastCheckTime = Date.now();

// Load active agents from localStorage
function loadActiveAgents() {
    const stored = localStorage.getItem('activeFieldAgents');
    if (stored) {
        activeFieldAgents = JSON.parse(stored);
    }
    renderActiveAgentsPanel();
}

// Save active agents
function saveActiveAgents() {
    localStorage.setItem('activeFieldAgents', JSON.stringify(activeFieldAgents));
}

// Add or update field agent activity
function trackFieldAgent(agentName, agentPhone, action = 'authenticated') {
    const existing = activeFieldAgents.find(a => a.phone === agentPhone);
    const now = new Date().toISOString();
    
    if (existing) {
        existing.lastActive = now;
        existing.lastAction = action;
        existing.sessionCount = (existing.sessionCount || 0) + 1;
    } else {
        activeFieldAgents.push({
            name: agentName,
            phone: agentPhone,
            firstSeen: now,
            lastActive: now,
            lastAction: action,
            sessionCount: 1,
            submissions: 0
        });
    }
    
    saveActiveAgents();
    renderActiveAgentsPanel();
}

// Update agent submission count
function incrementAgentSubmissions(agentPhone) {
    const agent = activeFieldAgents.find(a => a.phone === agentPhone);
    if (agent) {
        agent.submissions = (agent.submissions || 0) + 1;
        agent.lastAction = 'submitted new agent';
        agent.lastActive = new Date().toISOString();
        saveActiveAgents();
        renderActiveAgentsPanel();
    }
}

// Render active agents panel in admin dashboard
function renderActiveAgentsPanel() {
    // Check if panel already exists
    let panel = document.getElementById('activeAgentsPanel');
    
    if (!panel) {
        // Create panel
        panel = document.createElement('div');
        panel.id = 'activeAgentsPanel';
        panel.className = 'card';
        panel.style.marginTop = '20px';
        panel.style.padding = '20px';
        panel.style.borderLeft = '4px solid #2a5298';
        
        // Insert after stats cards
        const statsSection = document.querySelector('.stats-cards');
        if (statsSection) {
            statsSection.parentNode.insertBefore(panel, statsSection.nextSibling);
        }
    }
    
    // Sort agents by last active (newest first)
    const sortedAgents = [...activeFieldAgents].sort((a, b) => 
        new Date(b.lastActive) - new Date(a.lastActive)
    );
    
    // Count active in last 24 hours
    const activeToday = sortedAgents.filter(a => {
        const last = new Date(a.lastActive);
        const today = new Date();
        return last.toDateString() === today.toDateString();
    }).length;
    
    let html = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3 style="color: #1e3c72; display: flex; align-items: center; gap: 10px;">
                <i class="fas fa-users" style="color: #2a5298;"></i> 
                Field Team Activity
                <span style="background: #2a5298; color: white; padding: 3px 10px; border-radius: 20px; font-size: 14px;">
                    ${activeToday} Active Today
                </span>
            </h3>
            <button onclick="refreshActiveAgents()" class="action-btn view-btn" style="padding: 5px 15px;">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
        </div>
    `;
    
    if (sortedAgents.length === 0) {
        html += `
            <div style="text-align: center; padding: 30px; color: #666;">
                <i class="fas fa-user-slash" style="font-size: 40px; margin-bottom: 10px; color: #ccc;"></i>
                <p>No field agents have logged in yet.</p>
                <p style="font-size: 13px; margin-top: 5px;">Agents will appear here when they authenticate.</p>
            </div>
        `;
    } else {
        html += `<div style="overflow-x: auto;"><table style="width: 100%;">`;
        html += `
            <thead>
                <tr>
                    <th>Agent Name</th>
                    <th>Phone</th>
                    <th>Last Active</th>
                    <th>Last Action</th>
                    <th>Submissions</th>
                    <th>Sessions</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
        `;
        
        sortedAgents.forEach(agent => {
            const lastActive = new Date(agent.lastActive);
            const now = new Date();
            const diffMinutes = Math.floor((now - lastActive) / (1000 * 60));
            
            let status = '';
            let statusColor = '';
            
            if (diffMinutes < 5) {
                status = '🟢 Online';
                statusColor = '#28a745';
            } else if (diffMinutes < 60) {
                status = '🟡 Away (' + diffMinutes + ' min)';
                statusColor = '#ffc107';
            } else {
                status = '⚫ Offline';
                statusColor = '#6c757d';
            }
            
            const lastActiveFormatted = lastActive.toLocaleString('en-US', {
                month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
            });
            
            html += `
                <tr>
                    <td><strong>${agent.name}</strong></td>
                    <td>${agent.phone}</td>
                    <td>${lastActiveFormatted}</td>
                    <td>${agent.lastAction || 'Authenticated'}</td>
                    <td style="text-align: center;"><span style="background: #2a5298; color: white; padding: 3px 10px; border-radius: 20px;">${agent.submissions || 0}</span></td>
                    <td style="text-align: center;">${agent.sessionCount || 1}</td>
                    <td><span style="color: ${statusColor};">${status}</span></td>
                </tr>
            `;
        });
        
        html += `</tbody></table></div>`;
        html += `<p style="margin-top: 15px; font-size: 12px; color: #666; text-align: right;">
            <i class="fas fa-info-circle"></i> Last updated: ${new Date().toLocaleTimeString()}
        </p>`;
    }
    
    panel.innerHTML = html;
}

// Refresh active agents
function refreshActiveAgents() {
    renderActiveAgentsPanel();
}

// ==================== REAL-TIME NOTIFICATIONS ====================
// Check for new agent submissions every 10 seconds
let lastSubmissionCount = 0;
let notificationSound = null;
let notificationPermission = false;

// Initialize notifications
async function initNotifications() {
    if ('Notification' in window) {
        notificationPermission = Notification.permission === 'granted';
        
        if (Notification.permission === 'default') {
            const permission = await Notification.requestPermission();
            notificationPermission = permission === 'granted';
        }
        
        if (notificationPermission) {
            console.log('✅ Desktop notifications enabled');
        }
    }
}

// Show notification
function showNotification(title, body, agentData = null) {
    // Desktop notification
    if (notificationPermission) {
        new Notification(title, {
            body: body,
            icon: 'https://raw.githubusercontent.com/BarasaGodwilTech/Ezee-money/main/favicon.ico'
        });
    }
    
    // In-app notification
    showInAppNotification(title, body, agentData);
}

// Create in-app notification system
function showInAppNotification(title, message, agentData) {
    let notificationArea = document.getElementById('notificationArea');
    
    if (!notificationArea) {
        notificationArea = document.createElement('div');
        notificationArea.id = 'notificationArea';
        notificationArea.style.position = 'fixed';
        notificationArea.style.top = '20px';
        notificationArea.style.right = '20px';
        notificationArea.style.zIndex = '9999';
        notificationArea.style.maxWidth = '350px';
        document.body.appendChild(notificationArea);
    }
    
    const notificationId = 'notif-' + Date.now();
    const notification = document.createElement('div');
    notification.id = notificationId;
    notification.style.backgroundColor = '#d4edda';
    notification.style.color = '#155724';
    notification.style.border = '1px solid #c3e6cb';
    notification.style.borderRadius = '8px';
    notification.style.padding = '15px';
    notification.style.marginBottom = '10px';
    notification.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)';
    notification.style.animation = 'slideIn 0.3s ease';
    notification.style.cursor = 'pointer';
    
    notification.innerHTML = `
        <div style="display: flex; align-items: center; gap: 10px;">
            <i class="fas fa-user-plus" style="font-size: 24px; color: #28a745;"></i>
            <div style="flex: 1;">
                <strong style="font-size: 16px;">${title}</strong>
                <p style="margin: 5px 0 0; font-size: 14px;">${message}</p>
                ${agentData ? `
                    <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #c3e6cb;">
                        <small>
                            📋 ${agentData.fullName}<br>
                            📧 ${agentData.email}<br>
                            📱 ${agentData.personalNumber}
                        </small>
                    </div>
                ` : ''}
            </div>
            <button onclick="document.getElementById('${notificationId}').remove()" style="background: none; border: none; color: #155724; font-size: 18px; cursor: pointer;">&times;</button>
        </div>
    `;
    
    notification.onclick = function(e) {
        if (!e.target.closest('button')) {
            // Navigate to agents section and highlight the new agent
            showSection('agents');
            if (agentData && agentData.id) {
                setTimeout(() => viewAgent(agentData.id), 500);
            }
            this.remove();
        }
    };
    
    notificationArea.appendChild(notification);
    
    // Auto-remove after 10 seconds
    setTimeout(() => {
        const el = document.getElementById(notificationId);
        if (el) el.remove();
    }, 10000);
}

// Check for new submissions
async function checkForNewSubmissions() {
    if (!githubConfig.repoOwner || !githubConfig.repoName) return;
    
    try {
        const data = await fetchGitHubData();
        const currentCount = data.agents?.length || 0;
        
        if (lastSubmissionCount === 0) {
            lastSubmissionCount = currentCount;
            return;
        }
        
        if (currentCount > lastSubmissionCount) {
            // New submission detected!
            const newAgents = data.agents.slice(lastSubmissionCount - currentCount);
            const newAgent = newAgents[0]; // Most recent
            
            // Find which field agent submitted it
            const fieldAgent = activeFieldAgents.find(a => 
                newAgent.tradingName && newAgent.tradingName.includes(a.phone)
            );
            
            if (fieldAgent) {
                incrementAgentSubmissions(fieldAgent.phone);
            }
            
            // Show notification
            showNotification(
                '🚀 New Agent Registered!',
                `${newAgent.fullName} just registered as an agent`,
                newAgent
            );
            
            // Play sound
            playNotificationSound();
        }
        
        lastSubmissionCount = currentCount;
        
    } catch (error) {
        console.error('Error checking submissions:', error);
    }
}

// Play notification sound
function playNotificationSound() {
    try {
        const audio = new Audio('https://www.soundjay.com/misc/sounds/bell-ringing-05.mp3');
        audio.volume = 0.5;
        audio.play().catch(e => console.log('Sound play failed:', e));
    } catch (e) {
        console.log('Sound not supported');
    }
}

// ==================== DELETE AGENT FUNCTION ====================
// Complete deletion of agent and their images
async function deleteAgent(agentId) {
    const agent = agents.find(a => a.id === agentId);
    
    if (!agent) {
        alert('Agent not found!');
        return;
    }
    
    const confirmDelete = confirm(`⚠️ WARNING: This will permanently delete:\n\n` +
        `📋 Agent: ${agent.fullName}\n` +
        `📧 Email: ${agent.email}\n` +
        `🖼️ All uploaded images (ID Front, ID Back, Agent Photo)\n\n` +
        `This action CANNOT be undone!\n\n` +
        `Are you absolutely sure?`);
    
    if (!confirmDelete) return;
    
    // Double confirm
    const secondConfirm = prompt(`Type "DELETE" to confirm permanent deletion of ${agent.fullName}:`);
    
    if (secondConfirm !== 'DELETE') {
        alert('Deletion cancelled.');
        return;
    }
    
    // Show loading
    const deleteBtn = event?.target;
    const originalText = deleteBtn?.innerHTML;
    if (deleteBtn) {
        deleteBtn.innerHTML = '<span class="loading"></span> Deleting...';
        deleteBtn.disabled = true;
    }
    
    try {
        // Step 1: Delete images from GitHub
        if (githubConfig.accessToken) {
            const imageUrls = [
                agent.idFrontUrl,
                agent.idBackUrl,
                agent.agentPhotoUrl
            ].filter(url => url && url.includes('raw.githubusercontent.com'));
            
            for (const url of imageUrls) {
                try {
                    await deleteImageFromGitHub(url);
                    console.log('✅ Deleted image:', url);
                } catch (error) {
                    console.warn('Failed to delete image:', url, error);
                }
            }
        }
        
        // Step 2: Remove agent from data.json
        const agentIndex = agents.findIndex(a => a.id === agentId);
        if (agentIndex !== -1) {
            agents.splice(agentIndex, 1);
        }
        
        if (dataJson && dataJson.agents) {
            const dataIndex = dataJson.agents.findIndex(a => a.id === agentId);
            if (dataIndex !== -1) {
                dataJson.agents.splice(dataIndex, 1);
                dataJson.lastUpdated = new Date().toISOString();
            }
        }
        
        // Step 3: Save updated data.json to GitHub
        if (githubConfig.accessToken) {
            await saveDataToGitHub(dataJson || { agents: agents, lastUpdated: new Date().toISOString() });
        }
        
        // Step 4: Save to localStorage
        localStorage.setItem('dataJson', JSON.stringify(dataJson));
        
        // Step 5: Update UI
        updateDashboard();
        renderRecentAgents();
        renderAllAgents();
        
        // Close modal if open
        agentModal.style.display = 'none';
        
        alert(`✅ Agent ${agent.fullName} has been permanently deleted along with all images.`);
        
    } catch (error) {
        console.error('Deletion error:', error);
        alert('Error deleting agent: ' + error.message);
    } finally {
        if (deleteBtn) {
            deleteBtn.innerHTML = originalText;
            deleteBtn.disabled = false;
        }
    }
}

// Delete single image from GitHub
async function deleteImageFromGitHub(imageUrl) {
    if (!imageUrl || !githubConfig.accessToken) return;
    
    // Extract filepath from URL
    const urlParts = imageUrl.split('/');
    const filename = urlParts.pop();
    const branch = urlParts.pop();
    const repoPath = urlParts.slice(-2).join('/');
    const filepath = `images/${filename}`;
    
    const apiUrl = `https://api.github.com/repos/${githubConfig.repoOwner}/${githubConfig.repoName}/contents/${filepath}`;
    
    const headers = {
        'Content-Type': 'application/json',
        'Accept': 'application/vnd.github.v3+json',
        'Authorization': `token ${githubConfig.accessToken}`
    };
    
    // Get file SHA first
    let sha = null;
    try {
        const fileInfo = await fetch(apiUrl, { headers });
        if (fileInfo.ok) {
            const fileData = await fileInfo.json();
            sha = fileData.sha;
        }
    } catch (error) {
        // File doesn't exist
        return;
    }
    
    if (sha) {
        const body = {
            message: `Delete image: ${filename}`,
            sha: sha,
            branch: githubConfig.branchName
        };
        
        const response = await fetch(apiUrl, {
            method: 'DELETE',
            headers: headers,
            body: JSON.stringify(body)
        });
        
        if (!response.ok) {
            throw new Error(`Failed to delete image: ${response.statusText}`);
        }
    }
}

// ==================== ADD DELETE BUTTON TO AGENT VIEW ====================
// Override viewAgent to include delete button
const originalViewAgent = window.viewAgent;
window.viewAgent = function(agentId) {
    // Call original viewAgent first
    originalViewAgent(agentId);
    
    // Add delete button to modal
    setTimeout(() => {
        const modalBody = document.getElementById('agentModalBody');
        const verificationPanel = modalBody.querySelector('.verification-panel');
        
        const deleteButtonHTML = `
            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #ffebee;">
                <button onclick="deleteAgent('${agentId}')" 
                        style="background-color: #d32f2f; color: white; border: none; padding: 12px 20px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 14px; font-weight: 500;">
                    <i class="fas fa-trash"></i> Permanently Delete Agent
                </button>
                <p style="color: #d32f2f; font-size: 12px; margin-top: 8px;">
                    <i class="fas fa-exclamation-triangle"></i> Warning: This will delete all data and images. Cannot be undone.
                </p>
            </div>
        `;
        
        if (verificationPanel) {
            verificationPanel.insertAdjacentHTML('afterend', deleteButtonHTML);
        } else {
            modalBody.insertAdjacentHTML('beforeend', deleteButtonHTML);
        }
    }, 100);
};

// ==================== INITIALIZATION ====================
// Start everything when page loads
document.addEventListener('DOMContentLoaded', function() {
    // Initialize notifications
    initNotifications();
    
    // Load active agents
    loadActiveAgents();
    
    // Get initial submission count
    setTimeout(async () => {
        if (githubConfig.repoOwner && githubConfig.repoName) {
            try {
                const data = await fetchGitHubData();
                lastSubmissionCount = data.agents?.length || 0;
                console.log('📊 Initial submission count:', lastSubmissionCount);
            } catch (e) {
                console.log('Waiting for data...');
            }
        }
    }, 2000);
    
    // Check for new submissions every 10 seconds
    setInterval(checkForNewSubmissions, 10000);
    
    // Refresh active agents every 30 seconds
    setInterval(refreshActiveAgents, 30000);
    
    // Listen for field agent activity (via localStorage events)
    window.addEventListener('storage', function(e) {
        if (e.key === 'activeFieldAgents' || e.key === 'agentAuth') {
            loadActiveAgents();
        }
    });
});

// Expose functions globally
window.trackFieldAgent = trackFieldAgent;
window.incrementAgentSubmissions = incrementAgentSubmissions;
window.deleteAgent = deleteAgent;
window.refreshActiveAgents = refreshActiveAgents;

console.log('✅ Field Agent Tracking + Notifications + Delete Function installed!');
</script>
<!-- ============ FORCE LOGOUT ALL FIELD AGENTS ON PASSWORD CHANGE ============ -->
<script>
// This runs whenever admin sets or resets password - FORCES ALL AGENTS TO LOGOUT
const originalSetPassword = setAgentPassword;
window.setAgentPassword = async function() {
    // Call original function
    await originalSetPassword.apply(this, arguments);
    
    // After password is set/changed, force logout all field agents
    try {
        // Update the config.json with a session reset token
        const configData = await fetchConfigFromGitHub();
        
        // Add a session reset timestamp
        if (!configData.security) configData.security = {};
        configData.security.sessionResetAt = new Date().toISOString();
        configData.security.sessionResetReason = 'password_changed';
        
        // Save back to GitHub
        await saveConfigToGitHub(configData);
        
        console.log('🔄 Session reset token issued - all field agents will need to re-login');
        
        // Optional: Show confirmation
        setTimeout(() => {
            alert('✅ All field agents have been logged out and must login with the new password.');
        }, 500);
        
    } catch (error) {
        console.error('Error issuing session reset:', error);
    }
};

// Also override resetAgentPassword
const originalResetPassword = resetAgentPassword;
window.resetAgentPassword = async function() {
    await originalResetPassword.apply(this, arguments);
    
    try {
        const configData = await fetchConfigFromGitHub();
        if (!configData.security) configData.security = {};
        configData.security.sessionResetAt = new Date().toISOString();
        configData.security.sessionResetReason = 'password_deleted';
        await saveConfigToGitHub(configData);
        
        alert('✅ Password removed. All field agents have been logged out.');
        
    } catch (error) {
        console.error('Error:', error);
    }
}
</script>
    <!-- ============ FINAL FIX - DELETE PASSWORD WORKS + REAL-TIME TRACKING ============ -->
<script>
(function() {
    console.log('🚀 INSTALLING ADMIN FIXES - DELETE WORKS + REAL-TIME TRACKING');
    
    // ===========================================
    // 1. FIX RESET PASSWORD - ACTUALLY DELETES FROM GITHUB
    // ===========================================
    
    window.resetAgentPassword = async function() {
        const confirmReset = confirm('⚠️ WARNING: This will completely DELETE the agent password!\n\n' +
                                   'All field agents will be LOCKED OUT immediately.\n\n' +
                                   'Are you absolutely sure?');
        
        if (!confirmReset) return;
        
        // Double confirm
        const secondConfirm = prompt('Type "DELETE PASSWORD" to confirm:');
        if (secondConfirm !== 'DELETE PASSWORD') {
            alert('Reset cancelled.');
            return;
        }
        
        try {
            if (!window.githubConfig || !window.githubConfig.accessToken) {
                alert('❌ GitHub access token required. Please configure in settings.');
                return;
            }
            
            // Show loading
            alert('🔄 Removing password from GitHub...');
            
            // Fetch current config
            let configData = await window.fetchConfigFromGitHub();
            
            // Remove password hash
            if (configData.security) {
                delete configData.security.agentPasswordHash;
                configData.security.passwordResetAt = new Date().toISOString();
                configData.security.passwordResetBy = 'admin';
                configData.security.passwordDeleted = true;
            }
            
            // Add session reset timestamp - THIS LOGS OUT ALL AGENTS
            configData.security.sessionResetAt = new Date().toISOString();
            configData.security.sessionResetReason = 'password_deleted';
            
            // Save back to GitHub
            await window.saveConfigToGitHub(configData);
            
            // Also clear any stored password in localStorage
            localStorage.removeItem('agentPasswordHash');
            localStorage.removeItem('agentPassword');
            
            alert('✅ PASSWORD DELETED SUCCESSFULLY!\n\n' +
                  '✓ Password removed from GitHub\n' +
                  '✓ All field agents logged out immediately\n' +
                  '✓ No one can submit until you set a new password');
            
        } catch (error) {
            console.error('Reset error:', error);
            alert('❌ Error resetting password: ' + error.message);
        }
    };
    
    // ===========================================
    // 2. FIX VIEW PASSWORD - SHOWS ACTUAL PASSWORD
    // ===========================================
    
    window.viewAgentPassword = async function() {
        try {
            const configData = await window.fetchConfigFromGitHub();
            
            if (!configData || !configData.security || !configData.security.agentPasswordHash) {
                alert('No password has been set yet.');
                return;
            }
            
            // Since we can't reverse hash, show verification method
            const checkPassword = prompt('Enter the password to verify it exists:');
            
            if (checkPassword) {
                const hash = await window.createSHA256Hash(checkPassword);
                if (hash === configData.security.agentPasswordHash) {
                    alert('✅ PASSWORD IS CORRECT!\n\nPassword: ' + checkPassword + 
                          '\n\nMake note of this password for field agents.');
                } else {
                    alert('❌ Incorrect password.');
                }
            }
            
        } catch (error) {
            alert('Error: ' + error.message);
        }
    };
    
    // ===========================================
    // 3. FIX SET PASSWORD - WITH SESSION RESET
    // ===========================================
    
    const originalSetPassword = window.setAgentPassword;
    window.setAgentPassword = async function() {
        await originalSetPassword.apply(this, arguments);
        
        // After setting password, force logout all agents
        try {
            const configData = await window.fetchConfigFromGitHub();
            if (!configData.security) configData.security = {};
            
            configData.security.sessionResetAt = new Date().toISOString();
            configData.security.sessionResetReason = 'password_changed';
            
            await window.saveConfigToGitHub(configData);
            
            setTimeout(() => {
                alert('✅ All field agents have been logged out.\nThey must login with the new password.');
            }, 500);
            
        } catch (error) {
            console.error('Session reset error:', error);
        }
    };
    
    // ===========================================
    // 4. FIX CONFIG SAVE - ENSURE IT WORKS
    // ===========================================
    
    window.saveConfigToGitHub = async function(configData) {
        if (!window.githubConfig || !window.githubConfig.accessToken) {
            throw new Error('GitHub access token required');
        }
        
        const filepath = 'config.json';
        const apiUrl = `https://api.github.com/repos/${window.githubConfig.repoOwner}/${window.githubConfig.repoName}/contents/${filepath}`;
        
        const headers = {
            'Content-Type': 'application/json',
            'Accept': 'application/vnd.github.v3+json',
            'Authorization': `token ${window.githubConfig.accessToken}`
        };
        
        const jsonContent = JSON.stringify(configData, null, 2);
        const contentBase64 = btoa(unescape(encodeURIComponent(jsonContent)));
        
        let sha = null;
        try {
            const fileInfo = await fetch(apiUrl, { headers });
            if (fileInfo.ok) {
                const fileData = await fileInfo.json();
                sha = fileData.sha;
            }
        } catch (e) {}
        
        const body = {
            message: `Update config - ${new Date().toLocaleString()}`,
            content: contentBase64,
            branch: window.githubConfig.branchName || 'main'
        };
        
        if (sha) body.sha = sha;
        
        const response = await fetch(apiUrl, {
            method: 'PUT',
            headers: headers,
            body: JSON.stringify(body)
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.message || response.statusText);
        }
        
        return await response.json();
    };
    
    // ===========================================
    // 5. FIX REAL-TIME TRACKING - ACTUALLY UPDATES
    // ===========================================
    
    // Force refresh tracking panel every 2 seconds
    setInterval(function() {
        if (typeof window.loadActiveAgents === 'function') {
            window.loadActiveAgents();
        }
        if (typeof window.refreshActiveAgents === 'function') {
            window.refreshActiveAgents();
        }
    }, 2000);
    
    // Listen for storage events IMMEDIATELY
    window.addEventListener('storage', function(e) {
        if (e.key === 'activeFieldAgents' || e.key === 'lastActivity') {
            setTimeout(() => {
                if (typeof window.loadActiveAgents === 'function') {
                    window.loadActiveAgents();
                }
            }, 50);
        }
    });
    
    // Also check every second for new activity
    let lastActivity = localStorage.getItem('lastActivity');
    setInterval(function() {
        const current = localStorage.getItem('lastActivity');
        if (current !== lastActivity) {
            lastActivity = current;
            if (typeof window.loadActiveAgents === 'function') {
                window.loadActiveAgents();
            }
        }
    }, 1000);
    
    // ===========================================
    // 6. ENSURE createSHA256Hash EXISTS
    // ===========================================
    
    if (!window.createSHA256Hash) {
        window.createSHA256Hash = async function(text) {
            const encoder = new TextEncoder();
            const data = encoder.encode(text);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        };
    }
    
    // ===========================================
    // 7. ENSURE fetchConfigFromGitHub EXISTS
    // ===========================================
    
    if (!window.fetchConfigFromGitHub) {
        window.fetchConfigFromGitHub = async function() {
            const filepath = 'config.json';
            const url = `https://api.github.com/repos/${window.githubConfig.repoOwner}/${window.githubConfig.repoName}/contents/${filepath}`;
            const headers = { 'Accept': 'application/vnd.github.v3+json' };
            
            const response = await fetch(url, { headers });
            if (!response.ok) {
                if (response.status === 404) return { security: {}, github: {} };
                throw new Error('Failed to fetch config');
            }
            
            const data = await response.json();
            const content = decodeURIComponent(escape(atob(data.content)));
            return JSON.parse(content);
        };
    }
    
    console.log('✅ ADMIN FIXES INSTALLED - DELETE WORKS, TRACKING REAL-TIME!');
})();
</script>
    <!-- ============ ADMIN TOKEN VERIFICATION ============ -->
<script>
(function() {
    // Ensure admin's GitHub config is saved to localStorage
    const originalSaveConfig = window.saveGitHubConfig;
    if (originalSaveConfig) {
        window.saveGitHubConfig = function() {
            const result = originalSaveConfig.apply(this, arguments);
            
            // Verify token was saved
            const config = localStorage.getItem('githubConfig');
            if (config) {
                const parsed = JSON.parse(config);
                if (parsed.accessToken) {
                    console.log('✅ Admin GitHub token saved successfully');
                } else {
                    console.warn('⚠️ Admin GitHub token is missing!');
                    setTimeout(() => {
                        alert('⚠️ WARNING: GitHub access token is required for field agents to upload images.\n\nPlease enter your GitHub token in the configuration panel.');
                    }, 500);
                }
            }
            
            return result;
        };
    }
    
    console.log('✅ Admin token verification installed');
})();
</script>
    <!-- ============ FINAL FIX - STORE CONFIG IN GITHUB ============ -->
<script>
(function() {
    console.log('🔥 INSTALLING UNIVERSAL CONFIG STORAGE');
    
    // ===========================================
    // OVERRIDE SAVE GITHUB CONFIG - SAVE TO GITHUB
    // ===========================================
    
    window.saveGitHubConfig = async function() {
        const repoOwner = document.getElementById('repoOwner').value.trim();
        const repoName = document.getElementById('repoName').value.trim();
        const accessToken = document.getElementById('accessToken').value.trim();
        const branchName = document.getElementById('branchName').value.trim() || 'main';
        
        if (!repoOwner || !repoName) {
            alert('Please enter repository owner and name.');
            return;
        }
        
        if (!accessToken) {
            alert('⚠️ ACCESS TOKEN IS REQUIRED!\n\nField agents cannot upload images without a token.');
            return;
        }
        
        // Save to localStorage (this device only)
        const localConfig = {
            repoOwner: repoOwner,
            repoName: repoName,
            accessToken: accessToken,
            branchName: branchName
        };
        
        localStorage.setItem('githubConfig', JSON.stringify(localConfig));
        window.githubConfig = localConfig;
        
        // ===== CRITICAL: ALSO SAVE TO GITHUB =====
        // This makes it available to ALL devices!
        
        try {
            // Create or update config.json with GitHub settings
            const configFile = {
                github: {
                    repoOwner: repoOwner,
                    repoName: repoName,
                    branchName: branchName,
                    imagesFolder: 'images'
                },
                security: {},
                system: {
                    appName: "Ezee Money Agent Registration",
                    version: "1.0.0",
                    lastConfiguredBy: "admin",
                    lastConfiguredAt: new Date().toISOString()
                }
            };
            
            // Try to get existing config to preserve password
            try {
                const existing = await window.fetchConfigFromGitHub();
                if (existing && existing.security) {
                    configFile.security = existing.security;
                }
            } catch (e) {
                // No existing config, that's fine
            }
            
            // Save to GitHub
            const filepath = 'config.json';
            const apiUrl = `https://api.github.com/repos/${repoOwner}/${repoName}/contents/${filepath}`;
            
            const headers = {
                'Content-Type': 'application/json',
                'Accept': 'application/vnd.github.v3+json',
                'Authorization': `token ${accessToken}`
            };
            
            const jsonContent = JSON.stringify(configFile, null, 2);
            const contentBase64 = btoa(unescape(encodeURIComponent(jsonContent)));
            
            // Get SHA if file exists
            let sha = null;
            try {
                const fileInfo = await fetch(apiUrl, { headers });
                if (fileInfo.ok) {
                    const fileData = await fileInfo.json();
                    sha = fileData.sha;
                }
            } catch (e) {}
            
            const body = {
                message: `Update GitHub configuration by admin`,
                content: contentBase64,
                branch: branchName
            };
            
            if (sha) body.sha = sha;
            
            const response = await fetch(apiUrl, {
                method: 'PUT',
                headers: headers,
                body: JSON.stringify(body)
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.message || response.statusText);
            }
            
            alert('✅ SUCCESS!\n\n✓ GitHub configuration saved to THIS device\n✓ Also saved to GitHub repository\n✓ ALL field agents can now authenticate from ANY device');
            
        } catch (error) {
            console.error('Error saving to GitHub:', error);
            alert('⚠️ Configuration saved locally but FAILED to save to GitHub.\n\nError: ' + error.message + '\n\nField agents on other devices will not be able to authenticate.');
        }
        
        document.getElementById('configPanel').style.display = 'none';
        
        // Try to load data
        setTimeout(() => {
            if (typeof window.loadAgentData === 'function') {
                window.loadAgentData();
            }
        }, 1000);
    };
    
    // ===========================================
    // OVERRIDE SET AGENT PASSWORD - SAVE TO GITHUB
    // ===========================================
    
    const originalSetPassword = window.setAgentPassword;
    window.setAgentPassword = async function() {
        const password = prompt('Enter a password for field agents to use for authentication:');
        
        if (!password || password.length < 4) {
            alert('Password must be at least 4 characters long.');
            return;
        }
        
        const confirmPassword = prompt('Confirm the password:');
        
        if (password !== confirmPassword) {
            alert('Passwords do not match.');
            return;
        }
        
        try {
            if (!window.githubConfig || !window.githubConfig.accessToken) {
                alert('❌ Please configure GitHub settings FIRST.\n\nClick the gear icon ⚙️ and save your GitHub configuration with an access token.');
                return;
            }
            
            // Create hash
            const hash = await window.createSHA256Hash(password);
            
            // First, get existing config
            let configData;
            try {
                configData = await window.fetchConfigFromGitHub();
            } catch (e) {
                configData = {};
            }
            
            if (!configData.security) configData.security = {};
            if (!configData.github) configData.github = {};
            
            // Update security settings
            configData.security.agentPasswordHash = hash;
            configData.security.passwordSetAt = new Date().toISOString();
            configData.security.passwordSetBy = 'admin';
            configData.security.sessionResetAt = new Date().toISOString(); // Force logout
            configData.security.sessionResetReason = 'password_changed';
            
            // Ensure GitHub settings are preserved
            configData.github.repoOwner = window.githubConfig.repoOwner;
            configData.github.repoName = window.githubConfig.repoName;
            configData.github.branchName = window.githubConfig.branchName;
            configData.github.imagesFolder = 'images';
            
            // Save to GitHub
            await window.saveConfigToGitHub(configData);
            
            alert(`✅ PASSWORD SET SUCCESSFULLY!\n\nPassword: ${password}\n\n✓ Saved to GitHub repository\n✓ ALL field agents can now login with this password\n✓ Previous sessions have been terminated`);
            
        } catch (error) {
            console.error('Error:', error);
            alert('❌ Error setting password: ' + error.message);
        }
    };
    
    // ===========================================
    // OVERRIDE RESET AGENT PASSWORD - DELETE FROM GITHUB
    // ===========================================
    
    const originalResetPassword = window.resetAgentPassword;
    window.resetAgentPassword = async function() {
        const confirmReset = confirm('⚠️ WARNING: This will completely DELETE the agent password!\n\n' +
                                   '✓ Password removed from GitHub\n' +
                                   '✓ ALL field agents logged out immediately\n' +
                                   '✓ No one can submit until you set a new password\n\n' +
                                   'Are you absolutely sure?');
        
        if (!confirmReset) return;
        
        const secondConfirm = prompt('Type "DELETE PASSWORD" to confirm:');
        if (secondConfirm !== 'DELETE PASSWORD') {
            alert('Reset cancelled.');
            return;
        }
        
        try {
            if (!window.githubConfig || !window.githubConfig.accessToken) {
                alert('❌ GitHub access token required.');
                return;
            }
            
            // Fetch current config
            let configData;
            try {
                configData = await window.fetchConfigFromGitHub();
            } catch (e) {
                configData = {};
            }
            
            if (!configData.security) configData.security = {};
            
            // REMOVE the password hash
            delete configData.security.agentPasswordHash;
            
            // Add session reset to log out all agents
            configData.security.passwordResetAt = new Date().toISOString();
            configData.security.passwordResetBy = 'admin';
            configData.security.sessionResetAt = new Date().toISOString();
            configData.security.sessionResetReason = 'password_deleted';
            configData.security.passwordDeleted = true;
            
            // Save back to GitHub
            await window.saveConfigToGitHub(configData);
            
            alert('✅ PASSWORD DELETED SUCCESSFULLY!\n\n' +
                  '✓ Password removed from GitHub\n' +
                  '✓ ALL field agents logged out\n' +
                  '✓ No one can submit until you set a new password');
            
        } catch (error) {
            console.error('Reset error:', error);
            alert('❌ Error resetting password: ' + error.message);
        }
    };
    
    // ===========================================
    // OVERRIDE VIEW PASSWORD - VERIFY FROM GITHUB
    // ===========================================
    
    window.viewAgentPassword = async function() {
        try {
            const configData = await window.fetchConfigFromGitHub();
            
            if (!configData || !configData.security || !configData.security.agentPasswordHash) {
                alert('No password has been set yet.');
                return;
            }
            
            const checkPassword = prompt('Enter the current password to verify:');
            
            if (checkPassword) {
                const hash = await window.createSHA256Hash(checkPassword);
                if (hash === configData.security.agentPasswordHash) {
                    alert('✅ PASSWORD IS CORRECT!\n\nPassword: ' + checkPassword);
                } else {
                    alert('❌ Incorrect password.');
                }
            }
            
        } catch (error) {
            alert('Error: ' + error.message);
        }
    };
    
    // ===========================================
    // FIX FETCH CONFIG FROM GITHUB
    // ===========================================
    
    window.fetchConfigFromGitHub = async function() {
        if (!window.githubConfig || !window.githubConfig.repoOwner || !window.githubConfig.repoName) {
            throw new Error('GitHub repository not configured');
        }
        
        const filepath = 'config.json';
        const apiUrl = `https://api.github.com/repos/${window.githubConfig.repoOwner}/${window.githubConfig.repoName}/contents/${filepath}?ref=${window.githubConfig.branchName || 'main'}`;
        
        const headers = {
            'Accept': 'application/vnd.github.v3+json'
        };
        
        if (window.githubConfig.accessToken) {
            headers['Authorization'] = `token ${window.githubConfig.accessToken}`;
        }
        
        const response = await fetch(apiUrl, { headers });
        
        if (!response.ok) {
            if (response.status === 404) {
                return { security: {}, github: {} };
            }
            throw new Error(`Failed to fetch config: ${response.statusText}`);
        }
        
        const data = await response.json();
        const jsonContent = decodeURIComponent(escape(atob(data.content)));
        return JSON.parse(jsonContent);
    };
    
    // ===========================================
    // FIX SAVE CONFIG TO GITHUB
    // ===========================================
    
    window.saveConfigToGitHub = async function(configData) {
        if (!window.githubConfig || !window.githubConfig.accessToken) {
            throw new Error('GitHub access token required');
        }
        
        const filepath = 'config.json';
        const apiUrl = `https://api.github.com/repos/${window.githubConfig.repoOwner}/${window.githubConfig.repoName}/contents/${filepath}`;
        
        const headers = {
            'Content-Type': 'application/json',
            'Accept': 'application/vnd.github.v3+json',
            'Authorization': `token ${window.githubConfig.accessToken}`
        };
        
        const jsonContent = JSON.stringify(configData, null, 2);
        const contentBase64 = btoa(unescape(encodeURIComponent(jsonContent)));
        
        // Get SHA if file exists
        let sha = null;
        try {
            const fileInfo = await fetch(apiUrl, { headers });
            if (fileInfo.ok) {
                const fileData = await fileInfo.json();
                sha = fileData.sha;
            }
        } catch (e) {}
        
        const body = {
            message: `Update configuration - ${new Date().toLocaleString()}`,
            content: contentBase64,
            branch: window.githubConfig.branchName || 'main'
        };
        
        if (sha) body.sha = sha;
        
        const response = await fetch(apiUrl, {
            method: 'PUT',
            headers: headers,
            body: JSON.stringify(body)
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.message || response.statusText);
        }
        
        return await response.json();
    };
    
    // ===========================================
    // LOAD CONFIG ON STARTUP
    // ===========================================
    
    // Try to load existing config from GitHub on page load
    setTimeout(async () => {
        try {
            if (window.githubConfig && window.githubConfig.repoOwner && window.githubConfig.repoName) {
                const config = await window.fetchConfigFromGitHub();
                console.log('📋 Loaded config from GitHub');
            }
        } catch (e) {
            console.log('No existing config found');
        }
    }, 2000);
    
    console.log('✅ UNIVERSAL CONFIG STORAGE INSTALLED');
    console.log('📌 GitHub config now saved to repository - available on ALL devices!');
})();
    </script>
    <!-- ============ UPDATE EXCEL EXPORT WITH SC CODE ============ -->
<script>
(function() {
    console.log('📊 UPDATING EXCEL EXPORT FOR SC CODE');
    
    // Override exportToExcel to include SC Code
    const originalExport = window.exportToExcel;
    window.exportToExcel = function() {
        if (!agents || agents.length === 0) {
            alert('No data available to export.');
            return;
        }
        
        const originalText = event.target.innerHTML;
        event.target.innerHTML = '<span class="loading"></span> Exporting...';
        event.target.disabled = true;
        
        try {
            // Create CSV content with SC CODE column
            let csvContent = "data:text/csv;charset=utf-8,";
            
            // NEW HEADERS - replaced Phone with SC Code
            const headers = [
                "Agent ID",
                "Full Name",
                "Email",
                "Email Verified",
                "Personal Number",
                "National ID",
                "Date of Birth",
                "Gender",
                "Business Address",
                "Residential Address",
                "Next of Kin Name",
                "Next of Kin Relationship",
                "Next of Kin Phone",
                "Field Agent SC Code", // Changed from Trading Name
                "Status",
                "Submission Date",
                "Admin Verified",
                "ID Front URL",
                "ID Back URL",
                "Agent Photo URL"
            ];
            
            csvContent += headers.join(",") + "\n";
            
            // Add data rows - now using tradingName as SC Code
            agents.forEach(agent => {
                const row = [
                    `"${agent.id || ''}"`,
                    `"${agent.fullName || ''}"`,
                    `"${agent.email || ''}"`,
                    `"${agent.emailVerified ? 'Yes' : 'No'}"`,
                    `"${agent.personalNumber || ''}"`,
                    `"${agent.nationalId || ''}"`,
                    `"${agent.dob || ''}"`,
                    `"${agent.gender || ''}"`,
                    `"${(agent.businessAddress || '').replace(/"/g, '""')}"`,
                    `"${(agent.residentialAddress || '').replace(/"/g, '""')}"`,
                    `"${agent.nextOfKinName || ''}"`,
                    `"${agent.nextOfKinRelationship || ''}"`,
                    `"${agent.nextOfKinPhone || ''}"`,
                    `"${agent.tradingName || ''}"`, // This now holds SC CODE
                    `"${agent.status || ''}"`,
                    `"${agent.submissionDate || ''}"`,
                    `"${agent.adminVerified ? 'Yes' : 'No'}"`,
                    `"${agent.idFrontUrl || ''}"`,
                    `"${agent.idBackUrl || ''}"`,
                    `"${agent.agentPhotoUrl || ''}"`
                ];
                csvContent += row.join(",") + "\n";
            });
            
            // Create download link
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            
            const date = new Date();
            const dateStr = date.toISOString().split('T')[0];
            link.setAttribute("download", `EzeeMoney_Agents_SC_Codes_${dateStr}.csv`);
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert(`✅ Exported ${agents.length} agents with SC Codes!`);
            
        } catch (error) {
            console.error('Export error:', error);
            alert('Error exporting data: ' + error.message);
        } finally {
            event.target.innerHTML = originalText;
            event.target.disabled = false;
        }
    };
    
    // Also update the Active Agents panel to show SC CODE instead of Phone
    const originalRender = window.renderActiveAgentsPanel;
    if (originalRender) {
        window.renderActiveAgentsPanel = function() {
            originalRender.call(this);
            
            // Modify the panel after it's rendered
            setTimeout(() => {
                const panel = document.getElementById('activeAgentsPanel');
                if (panel) {
                    // Change table headers from "Phone" to "SC Code"
                    const headers = panel.querySelectorAll('th');
                    headers.forEach(header => {
                        if (header.textContent.includes('Phone')) {
                            header.textContent = 'SC Code';
                        }
                    });
                    
                    // Update any field agent tracking display
                    console.log('✅ Updated tracking panel to show SC Code');
                }
            }, 100);
        };
    }
    
    console.log('✅ Excel export updated for SC Code');
})();
    </script>
    <!-- ============ FIX TRACKING PANEL TO SHOW SC CODE ============ -->
<script>
(function() {
    // Override how active agents are displayed to show SC Code instead of Phone
    const originalLoad = window.loadActiveAgents;
    if (originalLoad) {
        window.loadActiveAgents = function() {
            const stored = localStorage.getItem('activeFieldAgents');
            if (stored) {
                window.activeFieldAgents = JSON.parse(stored);
            }
            
            // Call original if it exists
            if (originalLoad) {
                originalLoad.call(this);
            } else {
                window.renderActiveAgentsPanel();
            }
        };
    }
    
    // Modify the render function to use SC Code
    window.renderActiveAgentsPanel = function() {
        let panel = document.getElementById('activeAgentsPanel');
        
        if (!panel) {
            panel = document.createElement('div');
            panel.id = 'activeAgentsPanel';
            panel.className = 'card';
            panel.style.marginTop = '20px';
            panel.style.padding = '20px';
            panel.style.borderLeft = '4px solid #2a5298';
            
            const statsSection = document.querySelector('.stats-cards');
            if (statsSection) {
                statsSection.parentNode.insertBefore(panel, statsSection.nextSibling);
            }
        }
        
        const sortedAgents = [...(window.activeFieldAgents || [])].sort((a, b) => 
            new Date(b.lastActive) - new Date(a.lastActive)
        );
        
        const activeToday = sortedAgents.filter(a => {
            const last = new Date(a.lastActive);
            const today = new Date();
            return last.toDateString() === today.toDateString();
        }).length;
        
        let html = `
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 style="color: #1e3c72; display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-users" style="color: #2a5298;"></i> 
                    Field Team Activity
                    <span style="background: #2a5298; color: white; padding: 3px 10px; border-radius: 20px; font-size: 14px;">
                        ${activeToday} Active Today
                    </span>
                </h3>
                <button onclick="window.refreshActiveAgents?.()" class="action-btn view-btn" style="padding: 5px 15px;">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>
        `;
        
        if (sortedAgents.length === 0) {
            html += `
                <div style="text-align: center; padding: 30px; color: #666;">
                    <i class="fas fa-user-slash" style="font-size: 40px; margin-bottom: 10px; color: #ccc;"></i>
                    <p>No field agents have logged in yet.</p>
                    <p style="font-size: 13px; margin-top: 5px;">Agents will appear here when they authenticate with SC Code.</p>
                </div>
            `;
        } else {
            html += `<div style="overflow-x: auto;"><table style="width: 100%;">`;
            html += `
                <thead>
                    <tr>
                        <th>Agent Name</th>
                        <th>SC Code</th> <!-- Changed from Phone -->
                        <th>Last Active</th>
                        <th>Last Action</th>
                        <th>Submissions</th>
                        <th>Sessions</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
            `;
            
            sortedAgents.forEach(agent => {
                const lastActive = new Date(agent.lastActive);
                const now = new Date();
                const diffMinutes = Math.floor((now - lastActive) / (1000 * 60));
                
                let status = '';
                let statusColor = '';
                
                if (diffMinutes < 5) {
                    status = '🟢 Online';
                    statusColor = '#28a745';
                } else if (diffMinutes < 60) {
                    status = '🟡 Away (' + diffMinutes + ' min)';
                    statusColor = '#ffc107';
                } else {
                    status = '⚫ Offline';
                    statusColor = '#6c757d';
                }
                
                const lastActiveFormatted = lastActive.toLocaleString('en-US', {
                    month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
                });
                
                html += `
                    <tr>
                        <td><strong>${agent.name || agent.agentName || ''}</strong></td>
                        <td><code style="background: #f0f0f0; padding: 4px 8px; border-radius: 4px;">${agent.scCode || agent.phone || ''}</code></td>
                        <td>${lastActiveFormatted}</td>
                        <td>${agent.lastAction || 'Authenticated'}</td>
                        <td style="text-align: center;"><span style="background: #2a5298; color: white; padding: 3px 10px; border-radius: 20px;">${agent.submissions || 0}</span></td>
                        <td style="text-align: center;">${agent.sessionCount || 1}</td>
                        <td><span style="color: ${statusColor};">${status}</span></td>
                    </tr>
                `;
            });
            
            html += `</tbody></table></div>`;
            html += `<p style="margin-top: 15px; font-size: 12px; color: #666; text-align: right;">
                <i class="fas fa-info-circle"></i> Last updated: ${new Date().toLocaleTimeString()}
            </p>`;
        }
        
        panel.innerHTML = html;
    };
    
    // Load agents on startup
    setTimeout(() => {
        const stored = localStorage.getItem('activeFieldAgents');
        if (stored) {
            window.activeFieldAgents = JSON.parse(stored);
            window.renderActiveAgentsPanel();
        }
    }, 500);
    
    console.log('✅ Tracking panel updated for SC Code');
})();
</script>
</body>
</html>
