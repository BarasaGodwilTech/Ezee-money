<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ezee Money Admin Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #4f46e5;
            --primary-dark: #4338ca;
            --secondary: #06b6d4;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --dark: #1f2937;
            --light: #f9fafb;
            --border: #e5e7eb;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--light);
            color: var(--dark);
            line-height: 1.6;
        }

        .dashboard-container {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 250px;
            background: var(--dark);
            color: white;
            padding: 2rem 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }

        .sidebar h2 {
            text-align: center;
            margin-bottom: 2rem;
            font-size: 1.5rem;
        }

        .nav-item {
            display: block;
            padding: 1rem 1.5rem;
            color: white;
            text-decoration: none;
            transition: background 0.3s;
            cursor: pointer;
        }

        .nav-item:hover, .nav-item.active {
            background: var(--primary);
        }

        .main-content {
            flex: 1;
            margin-left: 250px;
            padding: 2rem;
        }

        .header {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary);
        }

        .agents-table {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .table-header {
            padding: 1.5rem;
            background: var(--primary);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        th {
            background: var(--light);
            font-weight: 600;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.3s;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 2rem;
            border-radius: 8px;
            width: 90%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--border);
            border-radius: 4px;
        }

        .status-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .status-verified {
            background: var(--success);
            color: white;
        }

        .status-pending {
            background: var(--warning);
            color: white;
        }

        .status-rejected {
            background: var(--danger);
            color: white;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid var(--border);
            border-top: 2px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .alert {
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }

        .alert-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }

        .alert-warning {
            background: #fed7aa;
            color: #92400e;
            border: 1px solid #fdba74;
        }

        .agent-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .detail-group {
            margin-bottom: 1rem;
        }

        .detail-label {
            font-weight: 600;
            color: #666;
            margin-bottom: 0.25rem;
            font-size: 0.875rem;
        }

        .detail-value {
            padding: 0.5rem;
            background: #f9f9f9;
            border-radius: 4px;
            border: 1px solid var(--border);
        }

        .photos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }

        .photo-container {
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
        }

        .photo-container img {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }

        .photo-label {
            padding: 0.5rem;
            background: var(--light);
            text-align: center;
            font-weight: 500;
        }

        .verification-panel {
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 8px;
            padding: 1.5rem;
            margin-top: 2rem;
        }

        .verification-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .main-content {
                margin-left: 0;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .table-header {
                flex-direction: column;
                gap: 1rem;
            }

            .agent-details {
                grid-template-columns: 1fr;
            }

            .verification-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <nav class="sidebar">
            <h2>üè¶ Ezee Money</h2>
            <a href="#" class="nav-item active" data-section="dashboard">üìä Dashboard</a>
            <a href="#" class="nav-item" data-section="agents">üë• Agents</a>
            <a href="#" class="nav-item" data-section="config">‚öôÔ∏è Configuration</a>
            <a href="#" class="nav-item" data-section="password">üîê Password</a>
            <a href="#" class="nav-item" data-section="export">üì§ Export</a>
        </nav>

        <main class="main-content">
            <div class="header">
                <h1>Admin Dashboard</h1>
                <div>
                    <span id="lastSync">Last sync: Never</span>
                    <button class="btn btn-primary" onclick="loadAgentData()">üîÑ Refresh</button>
                </div>
            </div>

            <div id="alertContainer"></div>

            <!-- Dashboard Section -->
            <section id="dashboard-section" class="content-section">
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Total Agents</h3>
                        <div class="stat-number" id="totalAgents">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Verified</h3>
                        <div class="stat-number" id="verifiedAgents">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Pending</h3>
                        <div class="stat-number" id="pendingAgents">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Active Today</h3>
                        <div class="stat-number" id="activeToday">0</div>
                    </div>
                </div>

                <div class="agents-table">
                    <div class="table-header">
                        <h3>Recent Agent Activity</h3>
                        <button class="btn btn-success" onclick="exportToExcel()">üì• Export Excel</button>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>SC Code</th>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Status</th>
                                <th>Submitted</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="recentAgentsTable">
                            <tr>
                                <td colspan="6" style="text-align: center;">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Configuration Section -->
            <section id="config-section" class="content-section" style="display: none;">
                <div class="agents-table">
                    <div class="table-header">
                        <h3>GitHub Configuration</h3>
                    </div>
                    <form id="githubConfigForm">
                        <div class="form-group">
                            <label for="repoOwner">Repository Owner</label>
                            <input type="text" id="repoOwner" value="BarasaGodwilTech" required>
                        </div>
                        <div class="form-group">
                            <label for="repoName">Repository Name</label>
                            <input type="text" id="repoName" value="Ezee-money" required>
                        </div>
                        <div class="form-group">
                            <label for="branchName">Branch Name</label>
                            <input type="text" id="branchName" value="main" required>
                        </div>
                        <div class="form-group">
                            <label for="imagesFolder">Images Folder</label>
                            <input type="text" id="imagesFolder" value="images" required>
                        </div>
                        <div class="form-group">
                            <label for="githubToken">GitHub Token</label>
                            <input type="password" id="githubToken" placeholder="Enter your GitHub personal access token">
                        </div>
                        <button type="submit" class="btn btn-primary">Save Configuration</button>
                    </form>
                </div>
            </section>

            <!-- Password Section -->
            <section id="password-section" class="content-section" style="display: none;">
                <div class="agents-table">
                    <div class="table-header">
                        <h3>Agent Password Management</h3>
                    </div>
                    <form id="passwordForm">
                        <div class="form-group">
                            <label for="newPassword">New Agent Password</label>
                            <input type="password" id="newPassword" placeholder="Enter password for field agents">
                        </div>
                        <div class="form-group">
                            <label for="confirmPassword">Confirm Password</label>
                            <input type="password" id="confirmPassword" placeholder="Confirm password">
                        </div>
                        <button type="submit" class="btn btn-primary">Set Password</button>
                        <button type="button" class="btn btn-warning" onclick="resetAgentPassword()">Reset Password</button>
                        <button type="button" class="btn btn-success" onclick="viewAgentPassword()">View Current Password</button>
                    </form>
                </div>
            </section>
        </main>
    </div>

    <!-- Agent Details Modal -->
    <div id="agentModal" class="modal">
        <div class="modal-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h3>Agent Details</h3>
                <button class="btn btn-danger btn-sm" onclick="closeAgentModal()">‚úï</button>
            </div>
            <div id="agentDetails"></div>
        </div>
    </div>

    <script>
        // Global variables
        let agents = [];
        let config = {};
        let githubToken = localStorage.getItem('githubToken') || '';

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        async function initializeApp() {
            try {
                await loadConfig();
                setupEventListeners();
                await loadAgentData();
                updateStats();
            } catch (error) {
                showAlert('Error initializing application: ' + error.message, 'error');
            }
        }

        // Configuration Management
        async function loadConfig() {
            try {
                const response = await fetch(`https://api.github.com/repos/BarasaGodwilTech/Ezee-money/contents/config.json`);
                const data = await response.json();
                config = JSON.parse(atob(data.content));
            } catch (error) {
                console.error('Error loading config:', error);
                config = {
                    github: {
                        repoOwner: 'BarasaGodwilTech',
                        repoName: 'Ezee-money',
                        branchName: 'main',
                        imagesFolder: 'images'
                    }
                };
            }
        }

        function setupEventListeners() {
            // Navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    const section = this.dataset.section;
                    showSection(section);
                    
                    // Update active nav
                    document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
                    this.classList.add('active');
                });
            });

            // GitHub Config Form
            document.getElementById('githubConfigForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                await saveGitHubConfig();
            });

            // Password Form
            document.getElementById('passwordForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                await setAgentPassword();
            });
        }

        function showSection(section) {
            document.querySelectorAll('.content-section').forEach(sec => {
                sec.style.display = 'none';
            });
            document.getElementById(section + '-section').style.display = 'block';
        }

        // GitHub Configuration
        async function saveGitHubConfig() {
            try {
                const repoOwner = document.getElementById('repoOwner').value;
                const repoName = document.getElementById('repoName').value;
                const branchName = document.getElementById('branchName').value;
                const imagesFolder = document.getElementById('imagesFolder').value;
                const token = document.getElementById('githubToken').value;

                if (!token) {
                    showAlert('GitHub token is required', 'error');
                    return;
                }

                // Save to localStorage
                localStorage.setItem('githubToken', token);
                githubToken = token;

                // Update config
                config.github = { repoOwner, repoName, branchName, imagesFolder };

                // Save to GitHub
                const configData = btoa(JSON.stringify(config, null, 2));
                const response = await fetch(`https://api.github.com/repos/${repoOwner}/${repoName}/contents/config.json`, {
                    method: 'GET',
                    headers: { 'Authorization': `token ${token}` }
                });
                const currentData = await response.json();

                await fetch(`https://api.github.com/repos/${repoOwner}/${repoName}/contents/config.json`, {
                    method: 'PUT',
                    headers: { 'Authorization': `token ${token}` },
                    body: JSON.stringify({
                        message: 'Update configuration',
                        content: configData,
                        sha: currentData.sha
                    })
                });

                showAlert('Configuration saved successfully', 'success');
            } catch (error) {
                showAlert('Error saving configuration: ' + error.message, 'error');
            }
        }

        // Password Management
        async function setAgentPassword() {
            try {
                const newPassword = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;

                if (newPassword !== confirmPassword) {
                    showAlert('Passwords do not match', 'error');
                    return;
                }

                if (!newPassword) {
                    showAlert('Password is required', 'error');
                    return;
                }

                // Create SHA-256 hash
                const hashBuffer = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(newPassword));
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');

                // Update config
                config.security = config.security || {};
                config.security.agentPasswordHash = hashHex;
                config.security.passwordSetAt = new Date().toISOString();
                config.security.passwordSetBy = 'admin';
                config.security.sessionResetAt = new Date().toISOString();
                config.security.sessionResetReason = 'password_changed';

                // Save to GitHub
                await updateConfigInGitHub();
                
                showAlert('Password set successfully', 'success');
                document.getElementById('passwordForm').reset();
            } catch (error) {
                showAlert('Error setting password: ' + error.message, 'error');
            }
        }

        async function resetAgentPassword() {
            if (!confirm('Are you sure you want to reset the agent password? This will log out all field agents.')) {
                return;
            }

            try {
                config.security = config.security || {};
                config.security.passwordDeleted = true;
                config.security.passwordResetAt = new Date().toISOString();
                config.security.passwordResetBy = 'admin';
                config.security.sessionResetAt = new Date().toISOString();
                config.security.sessionResetReason = 'password_reset';
                delete config.security.agentPasswordHash;

                await updateConfigInGitHub();
                showAlert('Password reset successfully', 'success');
            } catch (error) {
                showAlert('Error resetting password: ' + error.message, 'error');
            }
        }

        async function viewAgentPassword() {
            try {
                if (!config.security || !config.security.agentPasswordHash) {
                    showAlert('No password is currently set', 'warning');
                    return;
                }

                showAlert('Password is encrypted and cannot be viewed. Hash: ' + config.security.agentPasswordHash.substring(0, 20) + '...', 'info');
            } catch (error) {
                showAlert('Error viewing password: ' + error.message, 'error');
            }
        }

        async function updateConfigInGitHub() {
            const configData = btoa(JSON.stringify(config, null, 2));
            const response = await fetch(`https://api.github.com/repos/${config.github.repoOwner}/${config.github.repoName}/contents/config.json`, {
                method: 'GET',
                headers: { 'Authorization': `token ${githubToken}` }
            });
            const currentData = await response.json();

            await fetch(`https://api.github.com/repos/${config.github.repoOwner}/${config.github.repoName}/contents/config.json`, {
                method: 'PUT',
                headers: { 'Authorization': `token ${githubToken}` },
                body: JSON.stringify({
                    message: 'Update security configuration',
                    content: configData,
                    sha: currentData.sha
                })
            });
        }

        // Agent Data Management
        async function loadAgentData() {
            try {
                const response = await fetch(`https://api.github.com/repos/${config.github.repoOwner}/${config.github.repoName}/contents/data.json`);
                const data = await response.json();
                const agentData = JSON.parse(atob(data.content));
                agents = agentData.agents || [];
                
                renderAgentsTable();
                updateLastSync();
            } catch (error) {
                console.error('Error loading agent data:', error);
                showAlert('Error loading agent data', 'error');
            }
        }

        function renderAgentsTable() {
            const tbody = document.getElementById('recentAgentsTable');
            
            if (agents.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No agents found</td></tr>';
                return;
            }

            tbody.innerHTML = agents.slice(0, 10).map(agent => `
                <tr>
                    <td>${agent.tradingName || agent.personalNumber || 'N/A'}</td>
                    <td>${agent.fullName}</td>
                    <td>${agent.email}</td>
                    <td><span class="status-badge status-${agent.status}">${agent.status}</span></td>
                    <td>${new Date(agent.submissionDate).toLocaleDateString()}</td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="viewAgent('${agent.id}')">View</button>
                        <button class="btn btn-success btn-sm" onclick="verifyAgent('${agent.id}')" ${agent.status === 'verified' ? 'disabled' : ''}>Verify</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteAgent('${agent.id}')">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        function updateStats() {
            document.getElementById('totalAgents').textContent = agents.length;
            document.getElementById('verifiedAgents').textContent = agents.filter(a => a.status === 'verified').length;
            document.getElementById('pendingAgents').textContent = agents.filter(a => a.status === 'pending').length;
            
            const today = new Date().toDateString();
            const activeToday = agents.filter(a => new Date(a.submissionDate).toDateString() === today).length;
            document.getElementById('activeToday').textContent = activeToday;
        }

        function updateLastSync() {
            document.getElementById('lastSync').textContent = 'Last sync: ' + new Date().toLocaleTimeString();
        }

        // Agent Actions
        function viewAgent(agentId) {
            const agent = agents.find(a => a.id === agentId);
            if (!agent) return;

            const details = `
                <div class="agent-details">
                    <div class="detail-group">
                        <div class="detail-label">Full Name</div>
                        <div class="detail-value">${agent.fullName}</div>
                    </div>
                    <div class="detail-group">
                        <div class="detail-label">SC Code</div>
                        <div class="detail-value">${agent.tradingName || agent.personalNumber || 'N/A'}</div>
                    </div>
                    <div class="detail-group">
                        <div class="detail-label">Email</div>
                        <div class="detail-value">${agent.email}</div>
                    </div>
                    <div class="detail-group">
                        <div class="detail-label">National ID</div>
                        <div class="detail-value">${agent.nationalId}</div>
                    </div>
                    <div class="detail-group">
                        <div class="detail-label">Date of Birth</div>
                        <div class="detail-value">${agent.dob}</div>
                    </div>
                    <div class="detail-group">
                        <div class="detail-label">Gender</div>
                        <div class="detail-value">${agent.gender}</div>
                    </div>
                    <div class="detail-group">
                        <div class="detail-label">Business Address</div>
                        <div class="detail-value">${agent.businessAddress}</div>
                    </div>
                    <div class="detail-group">
                        <div class="detail-label">Residential Address</div>
                        <div class="detail-value">${agent.residentialAddress}</div>
                    </div>
                    <div class="detail-group">
                        <div class="detail-label">Next of Kin Name</div>
                        <div class="detail-value">${agent.nextOfKinName}</div>
                    </div>
                    <div class="detail-group">
                        <div class="detail-label">Next of Kin Relationship</div>
                        <div class="detail-value">${agent.nextOfKinRelationship}</div>
                    </div>
                    <div class="detail-group">
                        <div class="detail-label">Next of Kin Phone</div>
                        <div class="detail-value">${agent.nextOfKinPhone}</div>
                    </div>
                </div>
                <div class="photos-grid">
                    <div class="photo-container">
                        <img src="${agent.idFrontUrl}" alt="ID Front" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <div class="detail-value" style="display:none; text-align: center; height: 200px; align-items: center; justify-content: center;">
                            ID Front Not Available
                        </div>
                        <div class="photo-label">ID Front</div>
                    </div>
                    <div class="photo-container">
                        <img src="${agent.idBackUrl}" alt="ID Back" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <div class="detail-value" style="display:none; text-align: center; height: 200px; align-items: center; justify-content: center;">
                            ID Back Not Available
                        </div>
                        <div class="photo-label">ID Back</div>
                    </div>
                    <div class="photo-container">
                        <img src="${agent.agentPhotoUrl}" alt="Agent Photo" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <div class="detail-value" style="display:none; text-align: center; height: 200px; align-items: center; justify-content: center;">
                            Agent Photo Not Available
                        </div>
                        <div class="photo-label">Agent Photo</div>
                    </div>
                </div>
                <div class="verification-panel">
                    <h4>Verification Status</h4>
                    <p>Current Status: <strong>${agent.status}</strong></p>
                    <div class="verification-actions">
                        <button class="btn btn-success" onclick="verifyAgent('${agent.id}')" ${agent.status === 'verified' ? 'disabled' : ''}>Verify Agent</button>
                        <button class="btn btn-warning" onclick="rejectAgent('${agent.id}')" ${agent.status === 'rejected' ? 'disabled' : ''}>Reject Agent</button>
                    </div>
                </div>
            `;

            document.getElementById('agentDetails').innerHTML = details;
            document.getElementById('agentModal').style.display = 'flex';
        }

        function closeAgentModal() {
            document.getElementById('agentModal').style.display = 'none';
        }

        async function verifyAgent(agentId) {
            try {
                const agent = agents.find(a => a.id === agentId);
                if (!agent) return;

                agent.status = 'verified';
                agent.adminVerified = true;
                agent.verifiedAt = new Date().toISOString();

                await saveAgentDataToGitHub();
                await loadAgentData();
                updateStats();
                showAlert('Agent verified successfully', 'success');
                closeAgentModal();
            } catch (error) {
                showAlert('Error verifying agent: ' + error.message, 'error');
            }
        }

        async function rejectAgent(agentId) {
            try {
                const agent = agents.find(a => a.id === agentId);
                if (!agent) return;

                agent.status = 'rejected';
                agent.adminVerified = false;
                agent.rejectedAt = new Date().toISOString();

                await saveAgentDataToGitHub();
                await loadAgentData();
                updateStats();
                showAlert('Agent rejected', 'success');
                closeAgentModal();
            } catch (error) {
                showAlert('Error rejecting agent: ' + error.message, 'error');
            }
        }

        async function deleteAgent(agentId) {
            if (!confirm('Are you sure you want to delete this agent? This action cannot be undone.')) {
                return;
            }

            try {
                const agent = agents.find(a => a.id === agentId);
                if (!agent) return;

                // Delete images from GitHub
                if (agent.idFrontUrl) await deleteImageFromGitHub(agent.idFrontUrl);
                if (agent.idBackUrl) await deleteImageFromGitHub(agent.idBackUrl);
                if (agent.agentPhotoUrl) await deleteImageFromGitHub(agent.agentPhotoUrl);

                // Remove agent from array
                agents = agents.filter(a => a.id !== agentId);

                // Save updated data
                await saveAgentDataToGitHub();
                await loadAgentData();
                updateStats();
                showAlert('Agent deleted successfully', 'success');
                closeAgentModal();
            } catch (error) {
                showAlert('Error deleting agent: ' + error.message, 'error');
            }
        }

        async function deleteImageFromGitHub(imageUrl) {
            try {
                const path = imageUrl.split(`/${config.github.repoName}/${config.github.branchName}/`)[1];
                const response = await fetch(`https://api.github.com/repos/${config.github.repoOwner}/${config.github.repoName}/contents/${path}`, {
                    method: 'GET',
                    headers: { 'Authorization': `token ${githubToken}` }
                });
                const imageData = await response.json();

                await fetch(`https://api.github.com/repos/${config.github.repoOwner}/${config.github.repoName}/contents/${path}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `token ${githubToken}` },
                    body: JSON.stringify({
                        message: `Delete image ${path}`,
                        sha: imageData.sha
                    })
                });
            } catch (error) {
                console.error('Error deleting image:', error);
            }
        }

        async function saveAgentDataToGitHub() {
            const dataContent = {
                agents: agents,
                lastUpdated: new Date().toISOString()
            };

            const dataJson = btoa(JSON.stringify(dataContent, null, 2));
            
            const response = await fetch(`https://api.github.com/repos/${config.github.repoOwner}/${config.github.repoName}/contents/data.json`, {
                method: 'GET',
                headers: { 'Authorization': `token ${githubToken}` }
            });
            const currentData = await response.json();

            await fetch(`https://api.github.com/repos/${config.github.repoOwner}/${config.github.repoName}/contents/data.json`, {
                method: 'PUT',
                headers: { 'Authorization': `token ${githubToken}` },
                body: JSON.stringify({
                    message: 'Update agent data',
                    content: dataJson,
                    sha: currentData.sha
                })
            });
        }

        // Export Functions
        async function exportToExcel() {
            try {
                const rows = agents.map(agent => ({
                    'SC Code': agent.tradingName || agent.personalNumber || 'N/A',
                    'Full Name': agent.fullName,
                    'Email': agent.email,
                    'Phone': agent.personalNumber || 'N/A',
                    'National ID': agent.nationalId,
                    'Date of Birth': agent.dob,
                    'Gender': agent.gender,
                    'Business Address': agent.businessAddress,
                    'Residential Address': agent.residentialAddress,
                    'Next of Kin Name': agent.nextOfKinName,
                    'Next of Kin Phone': agent.nextOfKinPhone,
                    'Status': agent.status,
                    'Submission Date': new Date(agent.submissionDate).toLocaleDateString()
                }));

                // Create CSV content
                const headers = Object.keys(rows[0] || {});
                const csvContent = [
                    headers.join(','),
                    ...rows.map(row => headers.map(header => `"${row[header] || ''}"`).join(','))
                ].join('\n');

                // Download file
                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `agents_export_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);

                showAlert('Export completed successfully', 'success');
            } catch (error) {
                showAlert('Error exporting data: ' + error.message, 'error');
            }
        }

        // Utility Functions
        function showAlert(message, type = 'info') {
            const alertContainer = document.getElementById('alertContainer');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            
            alertContainer.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('agentModal');
            if (event.target === modal) {
                closeAgentModal();
            }
        }
    </script>
</body>
</html>
