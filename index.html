<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New Agent Registration</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding-bottom: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: white;
            padding: 20px;
            border-radius: 0 0 15px 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin-bottom: 25px;
            text-align: center;
        }
        
        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .logo i {
            font-size: 28px;
        }
        
        .logo h1 {
            font-size: 22px;
            font-weight: 600;
        }
        
        .header-subtitle {
            font-size: 14px;
            opacity: 0.9;
            margin-top: 5px;
        }
        
        .config-panel {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            display: none;
        }
        
        .config-panel h3 {
            color: #856404;
            margin-bottom: 10px;
        }
        
        .config-input {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        
        .config-input input {
            flex: 1;
            min-width: 200px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .config-btn {
            background-color: #856404;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .form-container {
            background-color: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }
        
        .form-title {
            color: #1e3c72;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #444;
        }
        
        label.required::after {
            content: " *";
            color: #e74c3c;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 14px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border 0.3s;
        }
        
        input:focus, select:focus, textarea:focus {
            border-color: #2a5298;
            outline: none;
            box-shadow: 0 0 0 2px rgba(42, 82, 152, 0.1);
        }
        
        .photo-section {
            margin-top: 30px;
        }
        
        .photo-instructions {
            background-color: #f8f9fa;
            border-left: 4px solid #2a5298;
            padding: 15px;
            margin: 15px 0;
            border-radius: 0 8px 8px 0;
        }
        
        .photo-instructions ul {
            padding-left: 20px;
            margin-top: 8px;
        }
        
        .photo-instructions li {
            margin-bottom: 5px;
        }
        
        .photo-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        @media (max-width: 768px) {
            .photo-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .photo-upload-area {
            border: 2px dashed #2a5298;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            background-color: #f8fafc;
            cursor: pointer;
            transition: all 0.3s;
            height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        .photo-upload-area:hover {
            background-color: #eef5ff;
        }
        
        .photo-icon {
            font-size: 40px;
            color: #2a5298;
            margin-bottom: 10px;
        }
        
        .photo-preview {
            width: 100%;
            height: 200px;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }
        
        .photo-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .remove-photo {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: rgba(231, 76, 60, 0.9);
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        
        .photo-label {
            font-weight: 600;
            margin-bottom: 10px;
            color: #1e3c72;
        }
        
        .buttons {
            display: flex;
            justify-content: center;
            margin-top: 30px;
        }
        
        .btn {
            padding: 16px 40px;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .btn-primary {
            background-color: #2a5298;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #1e3c72;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(30, 60, 114, 0.2);
        }
        
        .btn-primary:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn-success {
            background-color: #4cd964;
            color: white;
        }
        
        .btn-success:hover {
            background-color: #3bc753;
        }
        
        .hidden {
            display: none;
        }
        
        .success-message {
            background-color: #d4edda;
            color: #155724;
            padding: 30px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
            border: 1px solid #c3e6cb;
        }
        
        .success-message i {
            font-size: 50px;
            margin-bottom: 20px;
            color: #28a745;
        }
        
        .field-info {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
            font-style: italic;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .form-container {
                padding: 20px;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .config-toggle {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #2a5298;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 100;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #f0f0f0;
            border-radius: 10px;
            margin-top: 10px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background-color: #4cd964;
            width: 0%;
            transition: width 0.3s;
        }
        
        .upload-status {
            margin-top: 10px;
            font-size: 14px;
            color: #666;
        }
    </style>
</head>
<body>
    <!-- Config Toggle Button -->
    <button class="config-toggle" id="configToggle">
        <i class="fas fa-cog"></i>
    </button>
    
    <!-- Configuration Panel -->
    
    <!-- Replace the entire config-panel div with this: -->
<div class="config-panel" id="configPanel">
    <h3><i class="fas fa-user-lock"></i> Field Agent Authentication</h3>
    <p>Enter your details to access the submission system:</p>
    <div class="config-input">
        <input type="text" id="agentName" placeholder="Your Full Name">
        <input type="text" id="agentPhone" placeholder="Your Phone Number">
        <input type="password" id="agentPassword" placeholder="Access Password">
    </div>
    <div class="config-input">
        <button class="config-btn" onclick="authenticateAgent()">Authenticate</button>
        <button class="config-btn" onclick="resetAuth()">Reset</button>
    </div>
    
    <p style="font-size: 12px; color: #666; margin-top: 10px;">
        <strong>Note:</strong> Get your access password from the admin. Once authenticated, your name and phone will automatically be captured.
    </p>
</div>
    
    <header>
        <div class="logo">
            <i class="fas fa-user-tie"></i>
            <h1>New Agent Registration</h1>
        </div>
        <div class="header-subtitle">Fill in this form for agents not yet on the platform</div>
    </header>
    
    <div class="container">
        <div class="form-container">
            <h2 class="form-title"><i class="fas fa-user-circle"></i> Agent Information</h2>
            
            <div class="form-group">
                <label for="fullName" class="required">Full Name</label>
                <input type="text" id="fullName" placeholder="Enter agent's full name">
            </div>
            
            <div class="form-group">
                <label for="personalNumber" class="required">Business Owner Personal Number</label>
                <input type="text" id="personalNumber" placeholder="Enter personal number">
            </div>
            
            <div class="form-group">
                <label for="email" class="required">Email Address</label>
                <input type="email" id="email" placeholder="Enter valid email address">
                <div class="field-info">A verification email will be sent to this address</div>
            </div>
            
            <div class="form-group">
                <label for="nationalId" class="required">National ID Number</label>
                <input type="text" id="nationalId" placeholder="Enter National ID Number">
                <div class="field-info">Please do not add card number instead of NIN on UG IDs</div>
            </div>
            
            <div class="form-group">
                <label for="dob" class="required">Date of Birth</label>
                <input type="date" id="dob">
            </div>
            
            <div class="form-group">
                <label for="gender" class="required">Gender</label>
                <select id="gender">
                    <option value="">Select Gender</option>
                    <option value="female">Female</option>
                    <option value="male">Male</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="businessAddress" class="required">Business Address Landmark</label>
                <input type="text" id="businessAddress" placeholder="Enter business address landmark">
            </div>
            
            <div class="form-group">
                <label for="residentialAddress" class="required">Residential Address</label>
                <textarea id="residentialAddress" rows="3" placeholder="Enter residential address"></textarea>
            </div>
            
            <h2 class="form-title"><i class="fas fa-users"></i> Next of Kin Information</h2>
            
            <div class="form-group">
                <label for="nextOfKinName" class="required">Next of Kin Full Name</label>
                <input type="text" id="nextOfKinName" placeholder="Enter next of kin full name">
            </div>
            
            <div class="form-group">
                <label for="nextOfKinRelationship" class="required">Next of Kin Relationship to Agent</label>
                <select id="nextOfKinRelationship">
                    <option value="">Select Relationship</option>
                    <option value="spouse">Spouse</option>
                    <option value="parent">Parent</option>
                    <option value="child">Child</option>
                    <option value="sibling">Sibling</option>
                    <option value="other_relative">Other Relative</option>
                    <option value="friend">Friend</option>
                    <option value="business_partner">Business Partner</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="nextOfKinPhone" class="required">Next of Kin Phone Number</label>
                <input type="tel" id="nextOfKinPhone" placeholder="Enter phone number">
            </div>
            
            <div class="form-group">
                <label for="tradingName">Field Onboarding agent name and phone number</label>
                <input type="text" id="tradingName" placeholder="Enter name and phone number">
                <div class="field-info">Fill in your name and phone number</div>
            </div>
            
            <div class="photo-section">
                <h2 class="form-title"><i class="fas fa-camera"></i> Photo Documentation</h2>
                
                <div class="photo-instructions">
                    <p><strong>Take 2 photos of the agent's ID:</strong></p>
                    <ul>
                        <li>Front and back for National ID</li>
                        <li>Passport bio data page and front cover for passport</li>
                    </ul>
                    <p style="margin-top: 10px;"><strong>Also take a passport photo of the agent:</strong></p>
                    <ul>
                        <li>Clear face photo against a plain background</li>
                        <li>Shoulder-up photo similar to passport photo</li>
                    </ul>
                </div>
                
                <div class="photo-grid">
                    <div>
                        <div class="photo-label">ID Front / Passport Bio Page *</div>
                        <div class="photo-upload-area" id="idFrontUpload">
                            <div class="photo-icon">
                                <i class="fas fa-id-card"></i>
                            </div>
                            <p><strong>Tap to upload</strong></p>
                            <p style="color: #666; font-size: 14px;">ID Front or Passport Bio Page</p>
                            <input type="file" id="idFrontInput" accept="image/*" capture="environment" style="display: none;">
                        </div>
                        <div class="photo-preview hidden" id="idFrontPreview">
                            <img id="idFrontImage" src="" alt="ID Front">
                            <div class="remove-photo" data-target="idFront">
                                <i class="fas fa-times"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <div class="photo-label">ID Back / Passport Cover</div>
                        <div class="photo-upload-area" id="idBackUpload">
                            <div class="photo-icon">
                                <i class="fas fa-id-card"></i>
                            </div>
                            <p><strong>Tap to upload</strong></p>
                            <p style="color: #666; font-size: 14px;">ID Back or Passport Cover</p>
                            <input type="file" id="idBackInput" accept="image/*" capture="environment" style="display: none;">
                        </div>
                        <div class="photo-preview hidden" id="idBackPreview">
                            <img id="idBackImage" src="" alt="ID Back">
                            <div class="remove-photo" data-target="idBack">
                                <i class="fas fa-times"></i>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 30px;">
                    <div class="photo-label">Agent Passport Photo *</div>
                    <div class="photo-upload-area" id="agentPhotoUpload">
                        <div class="photo-icon">
                            <i class="fas fa-user-circle"></i>
                        </div>
                        <p><strong>Tap to upload agent photo</strong></p>
                        <p style="color: #666; font-size: 14px;">Clear face photo for identification</p>
                        <input type="file" id="agentPhotoInput" accept="image/*" capture="environment" style="display: none;">
                    </div>
                    <div class="photo-preview hidden" id="agentPhotoPreview">
                        <img id="agentPhotoImage" src="" alt="Agent Photo">
                        <div class="remove-photo" data-target="agentPhoto">
                            <i class="fas fa-times"></i>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="buttons">
                <button type="button" id="submitBtn" class="btn btn-primary">
                    <i class="fas fa-paper-plane"></i> Submit Agent Registration
                </button>
            </div>
            
            <div id="uploadProgress" class="hidden">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="upload-status" id="uploadStatus">Preparing upload...</div>
            </div>
        </div>
        
        <!-- Success Message -->
        <div class="success-message hidden" id="successMessage">
            <i class="fas fa-check-circle"></i>
            <h3>Agent Registration Submitted Successfully!</h3>
            <p>The agent's information has been saved and images uploaded.</p>
            <p>An email will be sent to the agent for verification. if no email is recieved reach out to your area agent for assistance.</p>
            <p style="margin-top: 20px; font-weight: 600;">Submission ID: <span id="submissionId"></span></p>
            <p style="margin-top: 10px; font-size: 14px;">
    Images and Data uploaded to: Ezee Money Database
    <span id="imagesLocation" style="color: transparent"></span>
            </p>
            <div style="margin-top: 20px;">
                <button type="button" id="newAgentBtn" class="btn btn-primary" style="margin-right: 10px;">
                    <i class="fas fa-user-plus"></i> Register Another Agent
                </button>
                <a href="#" class="btn btn-success">
                    <i class="fas fa-chart-bar"></i> Go to Admin Dashboard
                </a>
            </div>
        </div>
    </div>

    <script>
        // Authentication configuration
let agentAuth = {
    isAuthenticated: false,
    agentName: '',
    agentPhone: '',
    agentPassword: ''
};

// GitHub Configuration (will be fetched after authentication)
let githubConfig = {
    repoOwner: 'BarasaGodwilTech',
    repoName: 'Ezee-money',
    accessToken: '',
    branchName: 'main',
    imagesSubfolder: 'images'
};

// Form data and photo storage
let formData = {
    idFront: null,
    idBack: null,
    agentPhoto: null
};

// DOM Elements
const configToggle = document.getElementById('configToggle');
const configPanel = document.getElementById('configPanel');
const submitBtn = document.getElementById('submitBtn');
const successMessage = document.getElementById('successMessage');
const submissionIdEl = document.getElementById('submissionId');
const imagesLocationEl = document.getElementById('imagesLocation');
const newAgentBtn = document.getElementById('newAgentBtn');
const uploadProgress = document.getElementById('uploadProgress');
const progressFill = document.getElementById('progressFill');
const uploadStatus = document.getElementById('uploadStatus');

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    loadAgentAuth();
    setupPhotoUploads();
    setupEventListeners();
    initializeForm();
    
    // Check if agent is already authenticated
    if (agentAuth.isAuthenticated) {
        autoFillAgentInfo();
    }
});

function setupEventListeners() {
    // Config toggle
    configToggle.addEventListener('click', () => {
        configPanel.style.display = configPanel.style.display === 'block' ? 'none' : 'block';
    });
    
    // Form submission
    submitBtn.addEventListener('click', handleSubmit);
    
    // New agent button
    newAgentBtn.addEventListener('click', () => {
        successMessage.classList.add('hidden');
        uploadProgress.classList.add('hidden');
        document.querySelector('.form-container').classList.remove('hidden');
        resetForm();
    });
}

function loadAgentAuth() {
    const savedAuth = localStorage.getItem('agentAuth');
    if (savedAuth) {
        agentAuth = JSON.parse(savedAuth);
        
        // Update form fields
        document.getElementById('agentName').value = agentAuth.agentName || '';
        document.getElementById('agentPhone').value = agentAuth.agentPhone || '';
        document.getElementById('agentPassword').value = '';
    }
}

async function authenticateAgent() {
    const agentName = document.getElementById('agentName').value.trim();
    const agentPhone = document.getElementById('agentPhone').value.trim();
    const agentPassword = document.getElementById('agentPassword').value.trim();
    
    if (!agentName || !agentPhone || !agentPassword) {
        alert('Please enter all authentication details.');
        return;
    }
    
    // Show loading
    const authBtn = document.querySelector('.config-btn');
    const originalText = authBtn.innerHTML;
    authBtn.innerHTML = '<span class="loading"></span> Authenticating...';
    authBtn.disabled = true;
    
    try {
        // Fetch configuration from admin (using the admin's stored GitHub config)
        await fetchAgentConfig(agentPassword);
        
        // Save authentication
        agentAuth.isAuthenticated = true;
        agentAuth.agentName = agentName;
        agentAuth.agentPhone = agentPhone;
        agentAuth.agentPassword = agentPassword;
        
        localStorage.setItem('agentAuth', JSON.stringify(agentAuth));
        
        // Auto-fill the onboarding field
        autoFillAgentInfo();
        
        // Hide config panel
        configPanel.style.display = 'none';
        
        alert('Authentication successful! Your details have been saved.');
        
    } catch (error) {
        alert('Authentication failed: ' + error.message);
        console.error('Authentication error:', error);
    } finally {
        authBtn.innerHTML = originalText;
        authBtn.disabled = false;
    }
}
// Helper function to create SHA-256 hash
async function createSHA256Hash(text) {
    try {
        // Encode the text
        const encoder = new TextEncoder();
        const data = encoder.encode(text);
        
        // Hash the data
        const hashBuffer = await crypto.subtle.digest('SHA-256', data);
        
        // Convert buffer to hex string
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        
        return hashHex;
    } catch (error) {
        // Fallback for browsers without crypto.subtle
        console.warn('Crypto API not available, using simple hash');
        return btoa(text).split('').reverse().join('');
    }
}
async function fetchAgentConfig(password) {
    try {
        // First, try to get admin's GitHub config from localStorage
        const adminConfig = localStorage.getItem('githubConfig');
        if (adminConfig) {
            const config = JSON.parse(adminConfig);
            githubConfig.repoOwner = config.repoOwner || githubConfig.repoOwner;
            githubConfig.repoName = config.repoName || githubConfig.repoName;
            githubConfig.accessToken = config.accessToken || '';
            githubConfig.branchName = config.branchName || githubConfig.branchName;
        }
        
        // Now fetch config from GitHub
        const configData = await fetchConfigFromGitHub();
        
        // Check if password hash exists
        if (!configData.security || !configData.security.agentPasswordHash) {
            throw new Error('System not configured. Please contact administrator.');
        }
        
        // Verify password
        const inputHash = await createSHA256Hash(password);
        if (inputHash !== configData.security.agentPasswordHash) {
            throw new Error('Invalid password. Please contact administrator.');
        }
        
        // IMPORTANT: Get GitHub access token from admin's localStorage
        // This allows field agents to upload images
        if (adminConfig) {
            const config = JSON.parse(adminConfig);
            githubConfig.accessToken = config.accessToken || '';
        }
        
        // Also get GitHub details from config.json if available
        if (configData.github) {
            githubConfig.repoOwner = configData.github.repoOwner || githubConfig.repoOwner;
            githubConfig.repoName = configData.github.repoName || githubConfig.repoName;
            githubConfig.branchName = configData.github.branchName || githubConfig.branchName;
            githubConfig.imagesSubfolder = configData.github.imagesFolder || 'images';
        }
        
        // Save to localStorage for this session
        localStorage.setItem('agentGitHubConfig', JSON.stringify(githubConfig));
        
        return true;
        
    } catch (error) {
        throw error;
    }
}

// Simple hash function (backward compatibility)
async function simpleHash(str) {
    return await createSHA256Hash(str);
}

async function fetchConfigFromGitHub() {
    const filepath = `config.json`;
    const apiUrl = `https://api.github.com/repos/${githubConfig.repoOwner}/${githubConfig.repoName}/contents/${filepath}`;
    
    const headers = {
        'Accept': 'application/vnd.github.v3+json'
    };
    
    const response = await fetch(apiUrl, { headers });
    
    if (!response.ok) {
        if (response.status === 404) {
            throw new Error('Configuration not found. Please contact administrator.');
        }
        throw new Error(`Failed to fetch config: ${response.statusText}`);
    }
    
    const data = await response.json();
    const jsonContent = decodeURIComponent(escape(atob(data.content)));
    return JSON.parse(jsonContent);
}

async function fetchAdminGitHubConfig() {
    // Try to get GitHub config from various possible sources
    let config = null;
    
    // First, check if we have the admin's config in localStorage
    const adminConfig = localStorage.getItem('githubConfig');
    if (adminConfig) {
        config = JSON.parse(adminConfig);
    } else {
        // Try to get from config.json
        try {
            const configData = await fetchConfigFromGitHub();
            if (configData.github) {
                config = {
                    repoOwner: configData.github.repoOwner,
                    repoName: configData.github.repoName,
                    branchName: configData.github.branchName,
                    accessToken: '' // Access token is sensitive, not stored in config.json
                };
            }
        } catch (error) {
            // Use default config
            config = {
                repoOwner: 'BarasaGodwilTech',
                repoName: 'Ezee-money',
                accessToken: '',
                branchName: 'main'
            };
        }
    }
    
    // Update our githubConfig
    githubConfig = {
        ...githubConfig,
        ...config
    };
    
    // Save for this agent session
    localStorage.setItem('agentGitHubConfig', JSON.stringify(githubConfig));
}

function autoFillAgentInfo() {
    if (agentAuth.isAuthenticated && agentAuth.agentName && agentAuth.agentPhone) {
        const tradingNameField = document.getElementById('tradingName');
        tradingNameField.value = `${agentAuth.agentName} ${agentAuth.agentPhone}`;
        
        // Make it read-only so agents don't change it
        tradingNameField.readOnly = true;
        tradingNameField.style.backgroundColor = '#f5f5f5';
    }
}

function resetAuth() {
    agentAuth.isAuthenticated = false;
    agentAuth.agentName = '';
    agentAuth.agentPhone = '';
    agentAuth.agentPassword = '';
    
    localStorage.removeItem('agentAuth');
    
    document.getElementById('agentName').value = '';
    document.getElementById('agentPhone').value = '';
    document.getElementById('agentPassword').value = '';
    
    // Reset trading name field
    const tradingNameField = document.getElementById('tradingName');
    tradingNameField.value = '';
    tradingNameField.readOnly = false;
    tradingNameField.style.backgroundColor = '';
    
    alert('Authentication reset. Please authenticate again to submit.');
}

// Simple hash function for demo purposes
async function simpleHash(str) {
    const encoder = new TextEncoder();
    const data = encoder.encode(str);
    const hashBuffer = await crypto.subtle.digest('SHA-256', data);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
}

function initializeForm() {
    // Initialize date field (25 years ago as default)
    const today = new Date();
    const defaultDate = new Date(today.getFullYear() - 25, today.getMonth(), today.getDate());
    document.getElementById('dob').value = defaultDate.toISOString().split('T')[0];
    
    // Set min and max dates for DOB
    const minDate = new Date(today.getFullYear() - 70, today.getMonth(), today.getDate());
    const maxDate = new Date(today.getFullYear() - 18, today.getMonth(), today.getDate());
    document.getElementById('dob').min = minDate.toISOString().split('T')[0];
    document.getElementById('dob').max = maxDate.toISOString().split('T')[0];
}

function setupPhotoUploads() {
    // Photo upload functionality
    function setupPhotoUpload(uploadAreaId, inputId, previewId, imageId, dataKey) {
        const uploadArea = document.getElementById(uploadAreaId);
        const fileInput = document.getElementById(inputId);
        const preview = document.getElementById(previewId);
        const image = document.getElementById(imageId);
        
        uploadArea.addEventListener('click', () => {
            fileInput.click();
        });
        
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file || !file.type.match('image.*')) {
                alert('Please select a valid image file.');
                return;
            }
            
            // Compress image if too large
            if (file.size > 2 * 1024 * 1024) { // 2MB limit
                compressImage(file, 800, 0.7).then(compressedFile => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        image.src = e.target.result;
                        formData[dataKey] = compressedFile; // Store compressed file
                        uploadArea.classList.add('hidden');
                        preview.classList.remove('hidden');
                    };
                    reader.readAsDataURL(compressedFile);
                }).catch(error => {
                    alert('Error compressing image: ' + error.message);
                });
            } else {
                const reader = new FileReader();
                reader.onload = (e) => {
                    image.src = e.target.result;
                    formData[dataKey] = file; // Store original file
                    uploadArea.classList.add('hidden');
                    preview.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        });
        
        // Remove photo
        preview.querySelector('.remove-photo').addEventListener('click', () => {
            formData[dataKey] = null;
            preview.classList.add('hidden');
            uploadArea.classList.remove('hidden');
            fileInput.value = '';
        });
    }
    
    // Initialize photo uploads
    setupPhotoUpload('idFrontUpload', 'idFrontInput', 'idFrontPreview', 'idFrontImage', 'idFront');
    setupPhotoUpload('idBackUpload', 'idBackInput', 'idBackPreview', 'idBackImage', 'idBack');
    setupPhotoUpload('agentPhotoUpload', 'agentPhotoInput', 'agentPhotoPreview', 'agentPhotoImage', 'agentPhoto');
}

// Image compression function
function compressImage(file, maxWidth, quality) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (event) => {
            const img = new Image();
            img.src = event.target.result;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                let width = img.width;
                let height = img.height;
                
                // Calculate new dimensions
                if (width > maxWidth) {
                    height = (height * maxWidth) / width;
                    width = maxWidth;
                }
                
                canvas.width = width;
                canvas.height = height;
                
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);
                
                canvas.toBlob((blob) => {
                    const compressedFile = new File([blob], file.name, {
                        type: 'image/jpeg',
                        lastModified: Date.now()
                    });
                    resolve(compressedFile);
                }, 'image/jpeg', quality);
            };
            img.onerror = reject;
        };
        reader.onerror = reject;
    });
}

async function handleSubmit() {
    // Check if agent is authenticated
    if (!agentAuth.isAuthenticated) {
        alert('Please authenticate first. Click the gear icon ⚙️ in the top right.');
        configPanel.style.display = 'block';
        return;
    }
    
    // Validate form
    if (!validateForm()) {
        return;
    }
    
    // Check GitHub configuration
    // Check GitHub configuration
    if (!githubConfig.repoOwner || !githubConfig.repoName) {
        alert('System configuration missing. Please authenticate again.');
        configPanel.style.display = 'block';
        return;
    }
    
    // Show progress bar
    uploadProgress.classList.remove('hidden');
    progressFill.style.width = '10%';
    uploadStatus.textContent = 'Preparing data...';
    
    // Generate submission ID
    const submissionId = generateSubmissionId();
    
    // Collect form data (without images)
    const agentData = {
        id: submissionId,
        fullName: document.getElementById('fullName').value.trim(),
        personalNumber: document.getElementById('personalNumber').value.trim(),
        email: document.getElementById('email').value.trim(),
        nationalId: document.getElementById('nationalId').value.trim(),
        dob: document.getElementById('dob').value,
        gender: document.getElementById('gender').value,
        businessAddress: document.getElementById('businessAddress').value.trim(),
        residentialAddress: document.getElementById('residentialAddress').value.trim(),
        nextOfKinName: document.getElementById('nextOfKinName').value.trim(),
        nextOfKinRelationship: document.getElementById('nextOfKinRelationship').value,
        nextOfKinPhone: document.getElementById('nextOfKinPhone').value.trim(),
        tradingName: document.getElementById('tradingName').value.trim(),
        submissionDate: new Date().toISOString(),
        status: 'pending',
        emailVerified: false,
        adminVerified: false,
        // Image URLs will be added after upload
        idFrontUrl: '',
        idBackUrl: '',
        agentPhotoUrl: ''
    };
    
    // Disable submit button
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="loading"></span> Uploading...';
    
    try {
        // Step 1: Upload images to GitHub
        uploadStatus.textContent = 'Uploading images to GitHub...';
        progressFill.style.width = '30%';
        
        const imageUrls = await uploadImagesToGitHub(submissionId);
        
        // Add image URLs to agent data
        agentData.idFrontUrl = imageUrls.idFrontUrl;
        agentData.idBackUrl = imageUrls.idBackUrl;
        agentData.agentPhotoUrl = imageUrls.agentPhotoUrl;
        
        // Step 2: Save agent data to data.json
        uploadStatus.textContent = 'Saving agent data...';
        progressFill.style.width = '70%';
        
        await saveAgentDataToGitHub(agentData);
        
        // Step 3: Complete
        progressFill.style.width = '100%';
        uploadStatus.textContent = 'Submission complete!';
        
        // Show success message
        setTimeout(() => {
            document.querySelector('.form-container').classList.add('hidden');
            uploadProgress.classList.add('hidden');
            submissionIdEl.textContent = submissionId;
            imagesLocationEl.textContent = `${githubConfig.repoOwner}/${githubConfig.repoName}/images/`;
            successMessage.classList.remove('hidden');
        }, 1000);
        
    } catch (error) {
        console.error('Submission error:', error);
        alert('Error submitting data: ' + error.message);
        
        // Reset UI
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Submit Agent Registration';
        uploadProgress.classList.add('hidden');
    }
}

// Upload images to GitHub and return URLs
async function uploadImagesToGitHub(submissionId) {
    const imageUrls = {
        idFrontUrl: '',
        idBackUrl: '',
        agentPhotoUrl: ''
    };
    
    // Upload each image that exists
    const uploads = [];
    let uploadCount = 0;
    const totalImages = Object.keys(formData).filter(key => formData[key] !== null).length;
    
    for (const [key, file] of Object.entries(formData)) {
        if (file) {
            uploadCount++;
            const progress = 30 + (uploadCount / totalImages * 40); // 30-70%
            progressFill.style.width = `${progress}%`;
            uploadStatus.textContent = `Uploading ${key.replace(/([A-Z])/g, ' $1').toLowerCase()}...`;
            
            try {
                const url = await uploadImageToGitHub(file, submissionId, key);
                imageUrls[`${key}Url`] = url;
            } catch (error) {
                throw new Error(`Failed to upload ${key}: ${error.message}`);
            }
        }
    }
    
    return imageUrls;
}

// Upload a single image to GitHub
async function uploadImageToGitHub(file, submissionId, imageType) {
    if (!file) return '';
    
    // Generate filename
    const timestamp = Date.now();
    const filename = `${submissionId}_${imageType}_${timestamp}.jpg`;
    const filepath = `${githubConfig.imagesSubfolder}/${filename}`;
    
    // Convert file to base64
    const base64Content = await fileToBase64(file);
    
    // Prepare API URL
    const apiUrl = `https://api.github.com/repos/${githubConfig.repoOwner}/${githubConfig.repoName}/contents/${filepath}`;
    
    // Prepare headers
    const headers = {
        'Content-Type': 'application/json',
        'Accept': 'application/vnd.github.v3+json',
        'Authorization': `token ${githubConfig.accessToken}`
    };
    
    // Prepare request body
    const body = {
        message: `Upload ${imageType} image for agent ${submissionId}`,
        content: base64Content.split(',')[1], // Remove data:image/jpeg;base64, prefix
        branch: githubConfig.branchName
    };
    
    // Send request to GitHub API
    const response = await fetch(apiUrl, {
        method: 'PUT',
        headers: headers,
        body: JSON.stringify(body)
    });
    
    if (!response.ok) {
        const errorData = await response.json();
        throw new Error(`GitHub API error: ${errorData.message || response.statusText}`);
    }
    
    // Return the raw content URL for the image
    return `https://raw.githubusercontent.com/${githubConfig.repoOwner}/${githubConfig.repoName}/${githubConfig.branchName}/images/${filename}`;
}

// Save agent data to GitHub data.json
async function saveAgentDataToGitHub(agentData) {
    // First, get the current data.json content
    let currentData;
    try {
        currentData = await fetchGitHubData();
    } catch (error) {
        // If file doesn't exist, create new data
        currentData = {
            agents: [],
            lastUpdated: new Date().toISOString()
        };
    }
    
    // Add new agent
    currentData.agents.push(agentData);
    currentData.lastUpdated = new Date().toISOString();
    
    // Convert to JSON
    const jsonContent = JSON.stringify(currentData, null, 2);
    
    // Create base64 encoded content
    const contentBase64 = btoa(unescape(encodeURIComponent(jsonContent)));
    
    // Prepare API URL - data.json is in the same /data folder
    const filepath = `data.json`;
    const apiUrl = `https://api.github.com/repos/${githubConfig.repoOwner}/${githubConfig.repoName}/contents/${filepath}`;
    
    // Prepare headers
    const headers = {
        'Content-Type': 'application/json',
        'Accept': 'application/vnd.github.v3+json',
        'Authorization': `token ${githubConfig.accessToken}`
    };
    
    // First, try to get the file to get its SHA (needed for update)
    let sha = null;
    try {
        const fileInfo = await fetch(apiUrl, { headers });
        if (fileInfo.ok) {
            const fileData = await fileInfo.json();
            sha = fileData.sha;
        }
    } catch (error) {
        // File doesn't exist yet
    }
    
    // Prepare request body
    const body = {
        message: `Add new agent: ${agentData.fullName}`,
        content: contentBase64,
        branch: githubConfig.branchName
    };
    
    // Add SHA if we're updating existing file
    if (sha) {
        body.sha = sha;
    }
    
    // Send request to GitHub API
    const response = await fetch(apiUrl, {
        method: 'PUT',
        headers: headers,
        body: JSON.stringify(body)
    });
    
    if (!response.ok) {
        const errorData = await response.json();
        throw new Error(`GitHub API error: ${errorData.message || response.statusText}`);
    }
    
    return await response.json();
}

// Fetch data from GitHub
async function fetchGitHubData() {
    const filepath = `data.json`;
    const apiUrl = `https://api.github.com/repos/${githubConfig.repoOwner}/${githubConfig.repoName}/contents/${filepath}?ref=${githubConfig.branchName}`;
    
    const headers = {
        'Accept': 'application/vnd.github.v3+json'
    };
    
    // Add authorization if available (not required for public repos, but helps with rate limits)
    if (githubConfig.accessToken) {
        headers['Authorization'] = `token ${githubConfig.accessToken}`;
    }
    
    const response = await fetch(apiUrl, { headers });
    
    if (!response.ok) {
        throw new Error(`Failed to fetch data: ${response.statusText}`);
    }
    
    const data = await response.json();
    
    // Decode base64 content
    const jsonContent = decodeURIComponent(escape(atob(data.content)));
    
    return JSON.parse(jsonContent);
}

// Helper function to convert file to base64
function fileToBase64(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
    });
}

// Form validation
function validateForm() {
    const requiredFields = [
        {id: 'fullName', name: 'Full Name'},
        {id: 'personalNumber', name: 'Personal Number'},
        {id: 'email', name: 'Email'},
        {id: 'nationalId', name: 'National ID'},
        {id: 'gender', name: 'Gender'},
        {id: 'businessAddress', name: 'Business Address'},
        {id: 'residentialAddress', name: 'Residential Address'},
        {id: 'nextOfKinName', name: 'Next of Kin Name'},
        {id: 'nextOfKinRelationship', name: 'Next of Kin Relationship'},
        {id: 'nextOfKinPhone', name: 'Next of Kin Phone'}
    ];
    
    for (let field of requiredFields) {
        const element = document.getElementById(field.id);
        const value = element.value ? element.value.trim() : '';
        
        if (!value) {
            alert(`Please fill in the ${field.name} field.`);
            element.focus();
            return false;
        }
    }
    
    // Email validation
    const email = document.getElementById('email').value.trim();
    if (!isValidEmail(email)) {
        alert('Please enter a valid email address.');
        return false;
    }
    
    // Check if required photos are uploaded
    if (!formData.idFront) {
        alert('Please upload the front of the ID or passport bio page (required).');
        return false;
    }
    
    if (!formData.agentPhoto) {
        alert('Please upload a passport photo of the agent (required).');
        return false;
    }
    
    return true;
}

function isValidEmail(email) {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(email);
}

function generateSubmissionId() {
    const timestamp = Date.now();
    const random = Math.floor(Math.random() * 1000);
    return `AGENT-${timestamp}-${random}`;
}

function resetForm() {
    // Reset all form fields
    document.getElementById('fullName').value = '';
    document.getElementById('personalNumber').value = '';
    document.getElementById('email').value = '';
    document.getElementById('nationalId').value = '';
    document.getElementById('dob').value = '';
    document.getElementById('gender').value = '';
    document.getElementById('businessAddress').value = '';
    document.getElementById('residentialAddress').value = '';
    document.getElementById('nextOfKinName').value = '';
    document.getElementById('nextOfKinRelationship').value = '';
    document.getElementById('nextOfKinPhone').value = '';
    document.getElementById('tradingName').value = '';
    
    // Reset photos
    formData.idFront = null;
    formData.idBack = null;
    formData.agentPhoto = null;
    
    // Show upload areas, hide previews
    document.getElementById('idFrontUpload').classList.remove('hidden');
    document.getElementById('idFrontPreview').classList.add('hidden');
    document.getElementById('idBackUpload').classList.remove('hidden');
    document.getElementById('idBackPreview').classList.add('hidden');
    document.getElementById('agentPhotoUpload').classList.remove('hidden');
    document.getElementById('agentPhotoPreview').classList.add('hidden');
    
    // Reset file inputs
    document.getElementById('idFrontInput').value = '';
    document.getElementById('idBackInput').value = '';
    document.getElementById('agentPhotoInput').value = '';
    
    // Reset submit button
    submitBtn.disabled = false;
    submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Submit Agent Registration';
    
    // Re-initialize date field
    initializeForm();
}
    </script>
    <script>
// ==================== FIXED PERSISTENT AUTHENTICATION ====================
// This makes authentication persist across page refreshes

// Override and enhance the authentication system
document.addEventListener('DOMContentLoaded', function() {
    // Check for saved authentication on EVERY page load
    restoreAuthentication();
    
    // Also check when page becomes visible (user returns to tab)
    document.addEventListener('visibilitychange', function() {
        if (!document.hidden) {
            restoreAuthentication();
        }
    });
});

// Restore authentication from localStorage
function restoreAuthentication() {
    try {
        const savedAuth = localStorage.getItem('agentAuth');
        const savedConfig = localStorage.getItem('agentGitHubConfig');
        
        if (savedAuth && savedConfig) {
            const auth = JSON.parse(savedAuth);
            
            // Only restore if it was authenticated and not expired
            if (auth.isAuthenticated && auth.timestamp) {
                // Check if authentication is less than 7 days old
                const authAge = Date.now() - auth.timestamp;
                const maxAge = 7 * 24 * 60 * 60 * 1000; // 7 days
                
                if (authAge < maxAge) {
                    // Restore authentication state
                    agentAuth = auth;
                    githubConfig = JSON.parse(savedConfig);
                    
                    // Update UI
                    autoFillAgentInfo();
                    
                    // Hide config panel
                    configPanel.style.display = 'none';
                    
                    console.log('✅ Authentication restored from ' + new Date(auth.timestamp).toLocaleString());
                } else {
                    // Authentication expired, clear it
                    console.log('Authentication expired, please login again');
                    localStorage.removeItem('agentAuth');
                    localStorage.removeItem('agentGitHubConfig');
                }
            }
        }
    } catch (error) {
        console.error('Error restoring authentication:', error);
    }
}

// Override authenticateAgent to add timestamp
const originalAuthenticateAgent = authenticateAgent;
authenticateAgent = async function() {
    const agentName = document.getElementById('agentName').value.trim();
    const agentPhone = document.getElementById('agentPhone').value.trim();
    const agentPassword = document.getElementById('agentPassword').value.trim();
    
    if (!agentName || !agentPhone || !agentPassword) {
        alert('Please enter all authentication details.');
        return;
    }
    
    const authBtn = document.querySelector('.config-btn');
    const originalText = authBtn.innerHTML;
    authBtn.innerHTML = '<span class="loading"></span> Authenticating...';
    authBtn.disabled = true;
    
    try {
        await fetchAgentConfig(agentPassword);
        
        // Save authentication with TIMESTAMP for persistence
        agentAuth = {
            isAuthenticated: true,
            agentName: agentName,
            agentPhone: agentPhone,
            agentPassword: agentPassword,
            timestamp: Date.now() // Add timestamp for expiry checking
        };
        
        localStorage.setItem('agentAuth', JSON.stringify(agentAuth));
        
        autoFillAgentInfo();
        configPanel.style.display = 'none';
        
        alert('✅ Authentication successful! You will stay logged in for 7 days.');
        
    } catch (error) {
        alert('Authentication failed: ' + error.message);
    } finally {
        authBtn.innerHTML = originalText;
        authBtn.disabled = false;
    }
};

// Override resetAuth to clear everything properly
resetAuth = function() {
    agentAuth = {
        isAuthenticated: false,
        agentName: '',
        agentPhone: '',
        agentPassword: '',
        timestamp: null
    };
    
    // Clear ALL auth-related storage
    localStorage.removeItem('agentAuth');
    localStorage.removeItem('agentGitHubConfig');
    localStorage.removeItem('githubConfig'); // Also clear this to force fresh fetch
    
    document.getElementById('agentName').value = '';
    document.getElementById('agentPhone').value = '';
    document.getElementById('agentPassword').value = '';
    
    const tradingNameField = document.getElementById('tradingName');
    tradingNameField.value = '';
    tradingNameField.readOnly = false;
    tradingNameField.style.backgroundColor = '';
    
    alert('✅ Authentication reset. You have been logged out.');
};

// Fix autoFillAgentInfo to work with restored auth
const originalAutoFill = autoFillAgentInfo;
autoFillAgentInfo = function() {
    if (agentAuth && agentAuth.isAuthenticated && agentAuth.agentName && agentAuth.agentPhone) {
        const tradingNameField = document.getElementById('tradingName');
        tradingNameField.value = `${agentAuth.agentName} ${agentAuth.agentPhone}`;
        tradingNameField.readOnly = true;
        tradingNameField.style.backgroundColor = '#f5f5f5';
        console.log('✅ Auto-filled agent info from saved session');
    }
};

// Make sure auth persists on page refresh by running immediately
(function() {
    // Try to restore on script load
    setTimeout(restoreAuthentication, 100);
})();

console.log('✅ Persistent authentication enabled - Login lasts 7 days!');
    </script>
</body>
</html>
